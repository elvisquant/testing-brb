<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Fleet Overview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    window.tailwind = { config: { darkMode: 'class', theme: { extend: { colors: { primary: { DEFAULT: '#3b82f6', hover: '#2563eb', dark: '#60a5fa', 'dark-hover': '#3b82f6', light: '#dbeafe' }, secondary: { DEFAULT: '#10b981', hover: '#059669', dark: '#34d399', 'dark-hover': '#10b981', light: '#d1fae5' }, warning: { DEFAULT: '#f59e0b', hover: '#d97706', dark: '#fbbf24', 'dark-hover': '#f59e0b', light: '#fef3c7' }, danger: { DEFAULT: '#ef4444', hover: '#dc2626', dark: '#f87171', 'dark-hover': '#ef4444', light: '#fee2e2' }, info: { DEFAULT: '#3b82f6', light: '#dbeafe', dark: '#60a5fa' }, gray: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db', 400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151', 800: '#1f2937', 900: '#111827' } } } } } };
  </script>
  <style>
    body { font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    .kpi-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    .dark .kpi-card:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.25); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #a3a3a3; }
    .dark ::-webkit-scrollbar-track { background: #2d3748; }
    .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
    .kpi-value { font-size: 1.625rem; line-height: 2.125rem; word-break: break-all; }
    @media (min-width: 1024px) { .kpi-value { font-size: 1.75rem; line-height: 2.25rem; } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    .modal.hidden { display: none; }
    .modal { transition: opacity 0.25s ease; }
    .modal-content { transition: transform 0.25s ease; transform: scale(0.95); }
    .modal:not(.hidden) .modal-content { transform: scale(1); }
    #quickAddDropdown { animation: fadeIn 0.2s ease-out; min-width: 200px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .request-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 1.25rem; height: 1.25rem; padding: 0 0.375rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; background-color: #ef4444; color: white; }
    .dark .request-badge { background-color: #f87171; color: #111827; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white antialiased">

<!-- Main application wrapper -->
<div class="flex h-screen">
    <!-- Sidebar (Left) -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:shadow-lg md:border-r dark:border-gray-700 flex flex-col flex-shrink-0">
      <div class="flex items-center justify-between">
          <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
            <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
          </div>
          <button id="sidebar-close-button" class="md:hidden p-1 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
              <span class="sr-only">Fermer menu</span> <i data-lucide="x" class="w-5 h-5"></i>
          </button>
      </div>
      <nav class="flex-1 overflow-y-auto">
        <ul class="space-y-2">
            <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="/dashboard.html">Dashboard</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="file-check" class="w-5 h-5"></i><a href="/request.html">Requests <span class="request-badge ml-1" id="sidebarRequestCount">0</span></a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="/analytics.html">Analytics</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="users" class="w-5 h-5"></i><a href="/users.html">Users</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="/panne.html">Pannes</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="car" class="w-5 h-5"></i><a href="/vehicle.html">Vehicules</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="wrench" class="w-5 h-5"></i><a href="/reparation.html">Reparation</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="droplet" class="w-5 h-5"></i><a href="/fuel.html">Carburant</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="settings" class="w-5 h-5"></i><a href="/maintenance.html">Maintenance</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="route" class="w-5 h-5"></i><a href="/trip.html">Voyage</a> </li>
        </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Deconnexion</span>
            </a>
       </div>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 z-30 bg-black bg-opacity-50 hidden md:hidden"></div>
    
    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="bg-white dark:bg-gray-800 shadow p-3 flex justify-between items-center flex-shrink-0 h-16">
          <div class="flex items-center">
            <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none p-2 mr-2"> <i data-lucide="menu" class="w-6 h-6"></i> </button>
            <div class="text-lg font-bold text-primary dark:text-primary-light md:hidden">FleetDash</div>
          </div>
          <div class="hidden md:block text-xl font-semibold text-gray-700 dark:text-gray-200 flex-grow text-center">
              Dashboard Overview
          </div>
          <div class="flex items-center space-x-3">
              <button id="theme-toggle-header" class="theme-toggle text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300"></button>
          </div>
      </header>

      <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 space-y-4 md:space-y-6 lg:space-y-8">
          <header class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
              <div></div> 
              <div class="flex items-center space-x-3 w-full sm:w-auto">
                  <div class="relative flex-1 sm:flex-none">
                       <button id="quickAddBtn" class="bg-primary text-white px-3 py-2 sm:px-4 sm:py-2 rounded-lg hover:bg-primary-hover dark:bg-primary-dark dark:hover:bg-primary-dark-hover flex items-center gap-2 shadow-sm transition-colors w-full justify-center sm:w-auto">
                          <i data-lucide="plus-circle" class="w-5 h-5"></i> <span class="hidden sm:inline">Ajout Rapide</span>
                      </button>
                      <div id="quickAddDropdown" class="absolute right-0 mt-2 w-full sm:w-48 bg-white dark:bg-gray-700 rounded-md shadow-xl z-10 hidden border dark:border-gray-600">
                          <a href="/vehicle.html" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center gap-2"><i data-lucide="car" class="w-4 h-4"></i> Nouveau Vehicule</a>
                          <a href="/fuel.html" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center gap-2"><i data-lucide="fuel" class="w-4 h-4"></i> Log Carburant</a>
                          <a href="/panne.html" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Rapport Panne</a>
                      </div>
                  </div>
                  <input type="date" id="dashboardDateFilter" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent appearance-none w-full sm:w-auto">
              </div>
          </header>

          <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4 lg:gap-6">
              <div class="kpi-card bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg flex items-start justify-between">
                  <div><p class="text-sm text-gray-500 dark:text-gray-400">Total Vehicles</p><p id="kpiTotalVehicles" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">0</p></div>
                  <div class="p-2 sm:p-3 rounded-full bg-primary-light dark:bg-primary/20 text-primary dark:text-primary-light"><i data-lucide="truck" class="w-5 sm:w-6 h-5 sm:h-6"></i></div>
              </div>
              <div class="kpi-card bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg flex items-start justify-between">
                  <div><p class="text-sm text-gray-500 dark:text-gray-400">Planned Trips</p><p id="kpiPlannedTrips" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">0</p></div>
                  <div class="p-2 sm:p-3 rounded-full bg-secondary-light dark:bg-secondary/20 text-secondary dark:text-secondary-light"><i data-lucide="route" class="w-5 sm:w-6 h-5 sm:h-6"></i></div>
              </div>
              <div class="kpi-card bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg flex items-start justify-between">
                   <div><p class="text-sm text-gray-500 dark:text-gray-400">Repairs (Month)</p><p id="kpiRepairsMonth" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">0</p></div>
                  <div class="p-2 sm:p-3 rounded-full bg-warning-light dark:bg-warning/20 text-warning dark:text-warning-light"><i data-lucide="wrench" class="w-5 sm:w-6 h-5 sm:h-6"></i></div>
              </div>
              <div class="kpi-card bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg flex items-start justify-between">
                  <div><p class="text-sm text-gray-500 dark:text-gray-400">Fuel Cost (Week)</p><p id="kpiFuelCostWeek" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">$0</p></div>
                  <div class="p-2 sm:p-3 rounded-full bg-indigo-200 dark:bg-indigo-500/20 text-indigo-500 dark:text-indigo-400"><i data-lucide="fuel" class="w-5 sm:w-6 h-5 sm:h-6"></i></div>
              </div>
              <div class="kpi-card bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg flex items-start justify-between">
                  <div><p class="text-sm text-gray-500 dark:text-gray-400">Pending Requests</p><p id="kpiPendingRequests" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">0</p></div>
                  <div class="p-2 sm:p-3 rounded-full bg-danger-light dark:bg-danger/20 text-danger dark:text-danger-light"><i data-lucide="file-check" class="w-5 sm:w-6 h-5 sm:h-6"></i></div>
              </div>
          </section>

          <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
              <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Monthly Activity Summary</h3>
                  <div class="h-64 sm:h-72 md:h-80"><canvas id="monthlyActivityChart"></canvas></div>
              </div>
              <div class="bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Vehicle Status</h3>
                  <div class="h-64 sm:h-72 md:h-80 flex items-center justify-center"><canvas id="vehicleStatusChart"></canvas></div>
              </div>
          </section>
          
          <section class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
              <div class="md:col-span-1 bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">System Status</h3>
                  <div class="space-y-3">
                      <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">API Server</span><span class="text-sm font-medium text-green-500 dark:text-green-400 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-1"></i> Operational</span></div>
                      <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">Database</span><span class="text-sm font-medium text-green-500 dark:text-green-400 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-1"></i> Optimal</span></div>
                      <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">GPS Tracking</span><span class="text-sm font-medium text-yellow-500 dark:text-yellow-400 flex items-center"><i data-lucide="alert-circle" class="w-4 h-4 mr-1"></i> Minor Delay</span></div>
                       <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">Notification Service</span><span class="text-sm font-medium text-green-500 dark:text-green-400 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-1"></i> Active</span></div>
                  </div>
              </div>
              <div class="md:col-span-2 bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Top Performing Drivers (Last 30 Days)</h3>
                    <ul id="topPerformingDriversList" class="space-y-3">
                        <li class="p-2 text-sm text-gray-500">Loading...</li>
                    </ul>
              </div>
          </section>

          <section class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
              <div class="bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Recent Pannes</h3>
                  <ul id="recentPannesListDashboard" class="space-y-3 max-h-60 overflow-y-auto">
                       <li class="p-3"><div><p class="font-medium">Loading...</p></div></li>
                  </ul>
              </div>
              <div class="bg-white dark:bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Upcoming Trips</h3> 
                   <ul id="upcomingTripsListDashboard" class="space-y-3 max-h-60 overflow-y-auto">
                       <li class="p-3"><div><p class="font-medium">Loading...</p></div></li>
                  </ul>
              </div>
          </section>
        </main>

        <aside class="w-1/5 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden lg:block flex-shrink-0 border-l dark:border-gray-700 overflow-y-auto">
            <div class="flex justify-end items-center">
                <div class="text-right">
                    <div class="text-sm font-semibold" id="userDisplayNameRightSidebar">User</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400" id="userRoleDisplayRightSidebar">Role</div>
                </div>
                <img id="rightSidebarAdminAvatar" src="https://i.pravatar.cc/40?u=admin_stats_page" alt="Admin" class="w-10 h-10 rounded-full ml-2 object-cover">
            </div>
            <hr class="dark:border-gray-700/50">
            <div>
                <h4 class="font-semibold mb-3 text-gray-700 dark:text-gray-200">Key Performance Insights</h4>
                <ul id="keyPerformanceInsightsList" class="text-xs space-y-2.5 text-gray-600 dark:text-gray-300">
                    <li class="flex items-start space-x-2"><i data-lucide="loader-2" class="w-4 h-4 text-gray-400 animate-spin mt-0.5 shrink-0"></i><span>Loading insights...</span></li>
                </ul>
            </div>
            <hr class="dark:border-gray-700/50">
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-gray-700 dark:text-gray-200">Alerts & Notifications</h4>
                    <a href="#" id="viewAllNotificationsLink" class="text-xs text-primary dark:text-primary-light hover:underline">View All (<span id="notificationCount">0</span>)</a>
                </div>
                <div id="notificationsList" class="space-y-3 max-h-40 overflow-y-auto pr-1">
                     <div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin mt-0.5 flex-shrink-0"></i><p class="text-xs text-gray-700 dark:text-gray-300">Loading alerts...</p></div>
                </div>
            </div>
        </aside>
      </div>
    </div>
</div>

<!-- Info/Status Modal -->
<div id="infoStatusModal" class="modal fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black bg-opacity-50">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-800/30 mb-4"></div>
      <h3 id="infoStatusModalTitle" class="text-lg font-medium text-gray-900 dark:text-white mb-2">Status</h3>
      <div class="mt-2"><p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message.</p></div>
      <div class="mt-5 sm:mt-6"><button type="button" id="infoStatusModalOkButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button></div>
    </div>
  </div>
</div>

<script>
  // PAGE-SPECIFIC SCRIPT FOR DASHBOARD.HTML
  const API_BASE_URL = ''; // Keep empty if relative to the same domain
  const DASH_API_DATA_NAMESPACE = '/dashboard-data';
  const REQUEST_API_NAMESPACE = '/api/v1/requests';
  const LOGIN_PAGE_URL = "/login.html";

  let infoStatusModalTimeoutDashboard;
  function openInfoStatusModalOnDashboard(title, message, type = 'info', autoCloseDelay = 4000) {
    const modal = document.getElementById('infoStatusModal');
    if(!modal) { console.error("InfoStatusModal not found!"); alert(`${type}: ${title} - ${message}`); return; }
    const titleEl = modal.querySelector('#infoStatusModalTitle'), messageEl = modal.querySelector('#infoStatusModalMessage'), iconContainer = modal.querySelector('#infoStatusModalIconContainer'), okButton = modal.querySelector('#infoStatusModalOkButton');
    if(titleEl) titleEl.textContent = title; if(messageEl) messageEl.textContent = message;
    if (infoStatusModalTimeoutDashboard) clearTimeout(infoStatusModalTimeoutDashboard);
    let iconName = 'info', iColor = 'text-blue-600', bgColor = 'bg-blue-100', btn = 'bg-blue-600';
    if (type === 'success') { iconName = 'check-circle-2'; iColor = 'text-green-600'; bgColor = 'bg-green-100'; btn = 'bg-green-600'; }
    else if (type === 'error') { iconName = 'alert-triangle'; iColor = 'text-red-600'; bgColor = 'bg-red-100'; btn = 'bg-red-600'; }
    if(iconContainer) { iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${bgColor} dark:bg-opacity-30 mb-4`; iconContainer.innerHTML = `<i data-lucide="${iconName}" class="h-6 w-6 ${iColor}"></i>`; }
    if(okButton) { okButton.className = `w-full px-4 py-2 ${btn} text-white rounded-md hover:opacity-90`;}
    if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [iconContainer] });
    modal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
    if (autoCloseDelay > 0) { infoStatusModalTimeoutDashboard = setTimeout(() => closeInfoStatusModalOnDashboard(), autoCloseDelay); }
  }
  function closeInfoStatusModalOnDashboard() { if(infoStatusModalTimeoutDashboard) clearTimeout(infoStatusModalTimeoutDashboard); document.getElementById('infoStatusModal')?.classList.add('hidden'); document.body.style.overflow = ''; }

  function getDashboardAuthToken() { return localStorage.getItem('accessToken'); }
  function parseDashboardJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }}
  
  async function apiRequest(endpoint, method = 'GET', body = null) {
    const token = getDashboardAuthToken();
    if (!token) {
      openInfoStatusModalOnDashboard("Authentication Required", "Please log in to view data.", "error", 0);
      setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 2500);
      return Promise.reject(new Error("No auth token found"));
    }
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': `Bearer ${token}` };
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
      if (response.status === 401) { openInfoStatusModalOnDashboard("Authentication Error", "Session expired. Redirecting to login.", "error", 0); localStorage.clear(); setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 2500); throw new Error("Unauthorized"); }
      if (!response.ok) { const errData = await response.json().catch(() => ({detail: `Server error: ${response.status}`})); throw new Error(errData.detail); }
      if (response.status === 204 || !response.headers.get('content-length') || response.headers.get('content-length') === '0') return [];
      return await response.json();
    } catch (error) {
      console.error(`Error for ${method} ${endpoint}:`, error.message);
      openInfoStatusModalOnDashboard(`API Error`, error.message, "error", 0);
      throw error;
    }
  }

  function updateDashboardUserInfo() {
    const username = localStorage.getItem('username') || 'Guest';
    const role = localStorage.getItem('user_role') || 'User';
    const roleFormatted = role.charAt(0).toUpperCase() + role.slice(1);
    document.getElementById('userDisplayNameRightSidebar').textContent = username;
    document.getElementById('userRoleDisplayRightSidebar').textContent = roleFormatted;
  }
  
  const pageThemeToggleButton = document.getElementById('theme-toggle-header');
  function updatePageThemeIcon() { if (pageThemeToggleButton) { pageThemeToggleButton.innerHTML = document.documentElement.classList.contains('dark') ? '<i data-lucide="sun" class="w-5 h-5"></i>' : '<i data-lucide="moon" class="w-5 h-5"></i>'; if (typeof lucide !== 'undefined') lucide.createIcons(); } }
  function initializePageTheme() { if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); } else { document.documentElement.classList.remove('dark'); } updatePageThemeIcon(); }

  async function loadDashboardData() {
    try {
        const [kpiData, requestCountData] = await Promise.all([
            apiRequest(DASH_API_DATA_NAMESPACE + '/kpis'),
            apiRequest(REQUEST_API_NAMESPACE + '/count/pending')
        ]);

        if (kpiData) {
            document.getElementById('kpiTotalVehicles').textContent = kpiData.total_vehicles ?? '0';
            document.getElementById('kpiPlannedTrips').textContent = kpiData.planned_trips ?? '0';
            document.getElementById('kpiRepairsMonth').textContent = kpiData.repairs_this_month ?? '0';
            document.getElementById('kpiFuelCostWeek').textContent = `$${(kpiData.fuel_cost_this_week ?? 0).toFixed(2)}`;
        }
        if (requestCountData) {
            const count = requestCountData.count ?? '0';
            document.getElementById('kpiPendingRequests').textContent = count;
            const sidebarBadge = document.getElementById('sidebarRequestCount');
            if (sidebarBadge) sidebarBadge.textContent = count;
        }
        
        const insightsData = await apiRequest(DASH_API_DATA_NAMESPACE + '/performance-insights');
        const insightsListEl = document.getElementById('keyPerformanceInsightsList');
        if (insightsListEl) {
            if (insightsData?.fuel_efficiency && insightsData?.maintenance_compliance) {
                insightsListEl.innerHTML = ''; 
                const fe = insightsData.fuel_efficiency;
                let feText = fe.percentage_change !== null ? `${fe.percentage_change > 0 ? '+' : ''}${fe.percentage_change}%` : "N/A";
                let feIcon = 'minus', feColor = 'gray-500';
                if (fe.trend === "up") { feIcon = 'trending-up'; feColor = 'green-500'; } else if (fe.trend === "down") { feIcon = 'trending-down'; feColor = 'red-500'; }
                insightsListEl.innerHTML += `<li class="flex items-start space-x-2"><i data-lucide="${feIcon}" class="w-4 h-4 text-${feColor} mt-0.5 shrink-0"></i><span>Fuel Efficiency: <span class="font-medium">${feText}</span></span></li>`;
                insightsListEl.innerHTML += `<li class="flex items-start space-x-2"><i data-lucide="shield-check" class="w-4 h-4 text-blue-500 mt-0.5 shrink-0"></i><span>Maintenance: <span class="font-medium">${insightsData.maintenance_compliance.total_maintenance_records ?? 0}</span> logged</span></li>`;
            } else { insightsListEl.innerHTML = '<li class="p-2 text-sm text-red-500">Could not load insights.</li>'; }
            lucide.createIcons();
        }

        const alertsData = await apiRequest(DASH_API_DATA_NAMESPACE + '/alerts');
        const notificationsListEl = document.getElementById('notificationsList');
        const notificationCountEl = document.getElementById('notificationCount');
        if (notificationsListEl && notificationCountEl) {
            notificationsListEl.innerHTML = ''; 
            let activeAlertsCount = 0;
            const createAlertHTML = (alert, icon, color, type) => {
                if (!alert) return ''; activeAlertsCount++;
                return `<div class="flex items-start space-x-2 p-2.5 bg-${color}-100 dark:bg-${color}-500/20 rounded-lg"><i data-lucide="${icon}" class="w-5 h-5 text-${color}-500 dark:text-${color}-400 mt-0.5 shrink-0"></i><p class="text-xs text-gray-700 dark:text-gray-300"><span class="font-semibold">${type}:</span> Veh <span class="font-medium">${alert.plate_number||'N/A'}</span> - ${alert.message||'N/A'}.</p></div>`;
            };
            notificationsListEl.innerHTML += createAlertHTML(alertsData?.critical_panne, 'alert-octagon', 'red', 'Critical');
            notificationsListEl.innerHTML += createAlertHTML(alertsData?.maintenance_alert, 'tool', 'yellow', 'Maintenance');
            notificationsListEl.innerHTML += createAlertHTML(alertsData?.trip_alert, 'route', 'blue', 'Trip');
            if (activeAlertsCount === 0) notificationsListEl.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400 p-2.5">No new alerts.</p>';
            notificationCountEl.textContent = alertsData?.total_alerts ?? 0;
            lucide.createIcons();
        }
    } catch (error) {
        console.error("Error in loadDashboardData:", error.message);
    }
  }
  
  async function loadRecentActivityListsForDashboard() {
    const pannesListEl = document.getElementById('recentPannesListDashboard');
    const upcomingTripsListEl = document.getElementById('upcomingTripsListDashboard');
    if (pannesListEl) {
        pannesListEl.innerHTML = '<li class="p-3 text-sm text-gray-500">Loading...</li>';
        const data = await apiRequest(DASH_API_DATA_NAMESPACE + '/recent-pannes'); 
        if (data && Array.isArray(data)) pannesListEl.innerHTML = data.length > 0 ? data.map(p => `<li class="flex justify-between items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-md"><div><p class="font-medium">${p.vehicle?.plate_number||'N/A'}: ${p.category_panne?.panne_name||p.description||'Issue'}</p><p class="text-xs text-gray-500 dark:text-gray-400">${new Date(p.panne_date).toLocaleDateString()} - ${p.status}</p></div><a href="/panne.html#${p.id}" class="text-sm text-primary dark:text-primary-light hover:underline">View</a></li>`).join('') : '<li class="p-3 text-sm text-gray-500">No recent pannes.</li>';
        else pannesListEl.innerHTML = '<li class="p-3 text-sm text-red-500">Error loading pannes.</li>';
    }
    if (upcomingTripsListEl) {
        upcomingTripsListEl.innerHTML = '<li class="p-3 text-sm text-gray-500">Loading...</li>';
        const data = await apiRequest(DASH_API_DATA_NAMESPACE + '/upcoming-trips'); 
        if (data && Array.isArray(data)) upcomingTripsListEl.innerHTML = data.length > 0 ? data.map(t => `<li class="flex justify-between items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-md"><div><p class="font-medium">${t.vehicle?.plate_number||'N/A'}: ${t.purpose||'Trip'}</p><p class="text-xs text-gray-500 dark:text-gray-400">Starts: ${new Date(t.start_time).toLocaleString()}</p></div><a href="/trip.html#${t.id}" class="text-sm text-primary dark:text-primary-light hover:underline">Details</a></li>`).join('') : '<li class="p-3 text-sm text-gray-500">No upcoming trips.</li>';
        else upcomingTripsListEl.innerHTML = '<li class="p-3 text-sm text-red-500">Error loading trips.</li>';
    }
    lucide.createIcons();
  }

  async function loadTopPerformingDrivers() {
    const listEl = document.getElementById('topPerformingDriversList'); 
    if (!listEl) return;
    listEl.innerHTML = '<li class="p-2 text-sm text-gray-500">Loading...</li>';
    const data = await apiRequest(DASH_API_DATA_NAMESPACE + '/top-performing-drivers?limit=3'); 
    if (data && Array.isArray(data) && data.length > 0) listEl.innerHTML = data.map((d, i) => `<li class="flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-md"><div class="flex items-center space-x-3"><img src="https://i.pravatar.cc/40?u=driver${d.driver_id||i}" alt="${d.first_name}" class="w-8 h-8 rounded-full object-cover"><span class="font-medium text-sm text-gray-700 dark:text-gray-200">${d.first_name} ${d.last_name}</span></div><span class="text-sm text-green-500 dark:text-green-400">${d.performance_metric}</span></li>`).join('');
    else if (data && data.length === 0) listEl.innerHTML = '<li class="p-2 text-sm text-gray-500">No driver data.</li>';
    else listEl.innerHTML = '<li class="p-2 text-sm text-red-500">Could not load drivers.</li>';
  }

  let monthlyActivityChartInstance = null, vehicleStatusChartInstance = null;
  const getChartColorTailwind = (c, v = 'DEFAULT', f) => { try { let cl = window.tailwind.config.theme.extend.colors; return cl[c][v] || f; } catch { return f; } };
  
  async function fetchAndInitializeCharts(isThemeChange = false) {
    const [monthlyActivityData, vehicleStatusDataFromApi] = await Promise.all([
        apiRequest(DASH_API_DATA_NAMESPACE + '/charts/monthly-activity?months_to_display=12'),
        apiRequest(DASH_API_DATA_NAMESPACE + '/charts/vehicle-status')
    ]);
    const finalMonthlyData = monthlyActivityData || { labels: [], trips: [], maintenances: [], pannes: [] };
    const finalVehicleStatusData = vehicleStatusDataFromApi?.labels && vehicleStatusDataFromApi?.counts ? { labels: vehicleStatusDataFromApi.labels, data: vehicleStatusDataFromApi.counts } : { labels: ["No Data"], data: [1] }; 
    initializeDashboardCharts(isThemeChange, finalMonthlyData, finalVehicleStatusData);
  }

  function initializeDashboardCharts(isThemeChange, monthlyData, statusData) { 
    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)', tickColor = isDark ? '#9ca3af' : '#6b7280', legendLabelColor = isDark ? '#d1d5db' : '#4b5563', tooltipBgColor = isDark ? '#1f2937' : '#ffffff', tooltipTitleColor = isDark ? '#f9fafb' : '#111827', tooltipBodyColor = isDark ? '#e5e7eb' : '#374151', tooltipBorderColor = isDark ? '#374151' : '#e5e7eb';
    Chart.defaults.font.family = 'Inter, sans-serif'; Chart.defaults.color = tickColor;
    const monthlyCtx = document.getElementById('monthlyActivityChart')?.getContext('2d');
    if (monthlyCtx) { if (monthlyActivityChartInstance) monthlyActivityChartInstance.destroy(); monthlyActivityChartInstance = new Chart(monthlyCtx, { type: 'bar', data: { labels: monthlyData.labels, datasets: [ { label: 'Trips', data: monthlyData.trips, backgroundColor: getChartColorTailwind('primary', isDark?'dark':'DEFAULT', '#3b82f6'), borderRadius:4, barPercentage:0.5 }, { label: 'Maintenances', data: monthlyData.maintenances, backgroundColor: getChartColorTailwind('warning', isDark?'dark':'DEFAULT', '#f59e0b'), borderRadius:4, barPercentage:0.5 }, { label: 'Pannes', data: monthlyData.pannes, backgroundColor: getChartColorTailwind('danger', isDark?'dark':'DEFAULT', '#ef4444'), borderRadius:4, barPercentage:0.5 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: gridColor }, ticks: { precision: 0 } } }, plugins: { legend: { position: 'top', align:'end', labels: {color: legendLabelColor, usePointStyle:true, boxWidth:8} }, tooltip: { backgroundColor:tooltipBgColor, titleColor:tooltipTitleColor, bodyColor:tooltipBodyColor, borderColor:tooltipBorderColor, borderWidth:1} } } }); }
    const statusCtx = document.getElementById('vehicleStatusChart')?.getContext('2d');
    if (statusCtx) { if (vehicleStatusChartInstance) vehicleStatusChartInstance.destroy(); const statusColors = [getChartColorTailwind('secondary', isDark?'dark':'DEFAULT'), getChartColorTailwind('primary', isDark?'dark':'DEFAULT'), getChartColorTailwind('warning', isDark?'dark':'DEFAULT'), getChartColorTailwind('danger', isDark?'dark':'DEFAULT'), getChartColorTailwind('gray', '500')]; const chartHasData = statusData.labels[0] !== "No Data"; vehicleStatusChartInstance = new Chart(statusCtx, { type: 'doughnut', data: { labels: statusData.labels, datasets: [{ data: statusData.data, backgroundColor: chartHasData ? statusData.labels.map((_,i) => statusColors[i % statusColors.length]) : ['#e5e7eb'], borderColor: isDark ? '#1f2937' : '#fff', borderWidth: 3 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: chartHasData, position: 'bottom', labels: {color: legendLabelColor, usePointStyle:true, boxWidth:8}}, tooltip: { enabled: chartHasData } } } }); }
  }
  
  document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      initializePageTheme();
      updateDashboardUserInfo(); 

      const mobileMenuBtn = document.getElementById('mobile-menu-button'), sidebarCloseBtn = document.getElementById('sidebar-close-button'), sidebarOverlayEl = document.getElementById('sidebar-overlay'), sidebarEl = document.getElementById('sidebar');
      if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => { sidebarEl.classList.remove('-translate-x-full'); sidebarOverlayEl.classList.remove('hidden'); });
      if(sidebarCloseBtn) sidebarCloseBtn.addEventListener('click', () => { sidebarEl.classList.add('-translate-x-full'); sidebarOverlayEl.classList.add('hidden'); });
      if(sidebarOverlayEl) sidebarOverlayEl.addEventListener('click', () => { sidebarEl.classList.add('-translate-x-full'); sidebarOverlayEl.classList.add('hidden'); });
      
      if (pageThemeToggleButton) pageThemeToggleButton.addEventListener('click', async () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); updatePageThemeIcon(); await fetchAndInitializeCharts(true); });
      
      const quickAddBtn = document.getElementById('quickAddBtn'), quickAddDropdown = document.getElementById('quickAddDropdown');
      if(quickAddBtn && quickAddDropdown) { quickAddBtn.addEventListener('click', (e) => { e.stopPropagation(); quickAddDropdown.classList.toggle('hidden');}); document.addEventListener('click', (e) => { if (!quickAddBtn.contains(e.target) && !quickAddDropdown.contains(e.target)) quickAddDropdown.classList.add('hidden'); }); }

      document.getElementById('global-logout-btn')?.addEventListener('click', (e) => { e.preventDefault(); localStorage.clear(); window.location.href = LOGIN_PAGE_URL; });
      document.getElementById('infoStatusModalOkButton')?.addEventListener('click', closeInfoStatusModalOnDashboard);

      if (!getDashboardAuthToken()) {
          openInfoStatusModalOnDashboard("Authentication Required", "Redirecting to login...", "error", 0);
          setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 1500); 
          return; 
      }

      try {
          await Promise.all([
            loadDashboardData(), 
            loadRecentActivityListsForDashboard(), 
            loadTopPerformingDrivers(), 
            fetchAndInitializeCharts()
          ]);
      } catch(error) {
        console.error("A critical error occurred during the initial data loading sequence:", error);
      }
  });
</script>
</body>
</html>