<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Gestion Panne</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal {
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }

    .modal.hidden {
      visibility: hidden;
      opacity: 0;
    }

    .modal:not(.hidden) {
      visibility: visible;
      opacity: 1;
    }

    .dark .modal-content {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }

    .date-filter-btn.active,
    .status-filter-btn.active {
      background-color: #3b82f6;
      color: white;
    }

    .dark .date-filter-btn.active,
    .dark .status-filter-btn.active {
      background-color: #60a5fa;
    }

    .view-detail-label {
      font-weight: 500;
      color: #4b5563;
    }

    .dark .view-detail-label {
      color: #d1d5db;
    }

    .view-detail-value {
      color: #1f2937;
    }

    .dark .view-detail-value {
      color: #f9fafb;
    }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

  <!-- Main application wrapper -->
  <div class="flex h-screen">

    <!-- Sidebar (Left) -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg 
                             transform -translate-x-full transition-transform duration-300 ease-in-out 
                             md:relative md:translate-x-0 md:shadow-lg md:border-r dark:border-gray-700 
                             flex flex-col flex-shrink-0">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
          <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
        </div>
        <button id="sidebar-close-button"
          class="md:hidden text-gray-700 dark:text-gray-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <nav class="flex-1 overflow-y-auto">
        <ul class="space-y-2">
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard.html">Dashboard</a>
          </li>
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics.html">Analytics</a>
          </li>
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="user" class="w-5 h-5"></i><a href="users.html">Utilisateurs</a>
          </li>
          <li
            class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="panne.html">Panne</a>
          </li>
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="car" class="w-5 h-5"></i><a href="vehicle.html">Vehicule</a>
          </li>
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="wrench" class="w-5 h-5"></i><a href="reparation.html">Reparation</a>
          </li>
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="droplet" class="w-5 h-5"></i><a href="fuel.html">Carburant</a>
          </li>
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="settings" class="w-5 h-5"></i><a href="maintenance.html">Maintenance</a>
          </li>
          <li
            class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
            <i data-lucide="route" class="w-5 h-5"></i><a href="trip.html">Voyage</a>
          </li>
        </ul>
      </nav>
      <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
        <a href="#" id="global-logout-btn"
          class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
          <i data-lucide="log-out" class="w-5 h-5"></i><span>Deconnexion</span>
        </a>
      </div>
    </aside>

    <!-- Overlay for mobile menu -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Content Area Wrapper -->
    <div class="flex-1 flex flex-col overflow-hidden">

      <!-- Header -->
      <header class="bg-white dark:bg-gray-800 shadow p-3 flex justify-between items-center flex-shrink-0 h-16">
        <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none p-2">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <div class="text-lg font-bold text-primary dark:text-primary-light md:hidden">
          FleetDash
        </div>
        <div class="hidden md:block text-xl font-semibold text-gray-700 dark:text-gray-200">
          Gestion Panne
        </div>
        <div class="flex items-center space-x-3">
          <button id="theme-toggle-header"
            class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
          </button>
          <div class="flex items-center space-x-2">
            <img src="https://i.pravatar.cc/40?u=analyst_jane_doe" alt="Analyst"
              class="w-10 h-10 rounded-full object-cover">
            <div class="text-right">
              <div class="text-sm font-semibold" id="userDisplayNameHeader">Utilisateur</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Admin</div>
            </div>
          </div>
        </div>
      </header>

      <!-- Main scrollable content area -->
      <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Panne Table Section -->
          <section id="panne-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
              <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-2 sm:mb-0">Enregistrements</h2>
              <div class="flex flex-wrap gap-2 items-center">
                <button id="openAddPanneModalButton"
                  class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
                  <i data-lucide="plus" class="w-4 h-4"></i> Ajout Panne
                </button>
                <input type="text" id="panneSearch" placeholder="Search (vehicle, category, status...)"
                  class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <button id="exportExcelButton"
                  class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„
                  Excel</button>
                <button id="exportPdfButton"
                  class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
              </div>
            </div>

            <div class="mb-4 flex flex-wrap items-center gap-x-4 gap-y-2">
              <div>
                <span class="text-sm font-medium mr-2">Filtre Panne par Date:</span>
                <div class="inline-flex rounded-md shadow-sm" role="group">
                  <button id="panne-date-filter-today"
                    class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-l-md hover:bg-gray-100 dark:hover:bg-gray-700">Aujourdhui</button>
                  <button id="panne-date-filter-last7"
                    class="date-filter-btn px-3 py-1.5 text-sm border-t border-b dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Dernier
                    7 Jours</button>
                  <button id="panne-date-filter-last30"
                    class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Dernier
                    30 Jours</button>
                  <button id="panne-date-filter-all"
                    class="date-filter-btn px-3 py-1.5 text-sm border-t border-b border-r dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 active">Tous
                    les Temps</button>
                  <button id="panne-date-filter-custom-btn"
                    class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-r-md hover:bg-gray-100 dark:hover:bg-gray-700">Personnalise</button>
                </div>
              </div>
              <div>
                <span class="text-sm font-medium mr-2">Filtre par Status:</span>
                <select id="panneStatusFilter"
                  class="status-filter-select px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">Tous Status</option>
                  <option value="active">Active</option>
                  <option value="in_progress">Encours</option>
                  <option value="resolved">Resolve</option>
                  <option value="closed">Termine</option>
                </select>
              </div>
            </div>
            <div id="panneCustomDateRange"
              class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
              <input type="date" id="panneCustomStartDate"
                class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <span class="text-sm">to</span>
              <input type="date" id="panneCustomEndDate"
                class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <button id="applyCustomDateFilterButton"
                class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Appliquer</button>
            </div>

            <div class="overflow-x-auto">
              <table id="pannesTable" class="w-full text-left text-sm">
                <thead>
                  <tr class="border-b dark:border-gray-700">
                    <th class="py-3 px-2 font-semibold">ID</th>
                    <th class="px-2 font-semibold">Vehicule (Plaque)</th>
                    <th class="px-2 font-semibold">Categorie</th>
                    <th class="px-2 font-semibold">Status</th>
                    <th class="px-2 font-semibold">Date Panne</th>
                    <th class="px-2 font-semibold text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="pannesBody"></tbody>
              </table>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
              <div class="text-sm text-gray-600 dark:text-gray-400" id="pannesCount"></div>
              <div class="flex items-center space-x-1" id="pannesPagination"></div>
            </div>
          </section>
        </main>

        <aside
          class="w-1/5 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden lg:block flex-shrink-0 border-l dark:border-gray-700 overflow-y-auto">
          <div>
            <h4 class="font-semibold mb-3 text-gray-700 dark:text-gray-200">Key Performance Insights</h4>
            <ul id="keyPerformanceInsightsList" class="text-xs space-y-2.5 text-gray-600 dark:text-gray-300">
              <li class="flex items-start space-x-2"><i data-lucide="loader-2"
                  class="w-4 h-4 text-gray-400 animate-spin mt-0.5 shrink-0"></i><span>Loading insights...</span></li>
            </ul>
          </div>
          <hr class="dark:border-gray-700/50">
          <div>
            <div class="flex justify-between items-center mb-3">
              <h4 class="font-semibold text-gray-700 dark:text-gray-200">Alertes & Notifications</h4>
              <a href="#" id="viewAllNotificationsLink"
                class="text-xs text-primary dark:text-primary-light hover:underline">Voir Tous (<span
                  id="notificationCount">0</span>)</a>
            </div>
            <div id="notificationsList" class="space-y-3 max-h-40 overflow-y-auto pr-1">
              <div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i
                  data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin mt-0.5 flex-shrink-0"></i>
                <p class="text-xs text-gray-700 dark:text-gray-300">Chargement alertes...</p>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>


  <!-- Add/Edit Panne Modal -->
  <div id="addPanneModal"
    class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div
      class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="panneModalTitle">Ajout Nouveau Panne</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Complete details panne</p>
          </div>
          <button id="closeAddPanneModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
            <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
          </button>
        </div>
        <form id="addPanneForm" class="space-y-4">
          <input type="hidden" id="panneId_form">
          <div>
            <label for="panne_vehicle_id_form"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicule</label>
            <select id="panne_vehicle_id_form" required
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
              <option value="">Chargement Vehicules...</option>
            </select>
          </div>
          <div>
            <label for="panne_category_id_form"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categorie Panne</label>
            <select id="panne_category_id_form" required
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
              <option value="">Chargement Categories...</option>
            </select>
          </div>
          <div>
            <label for="panne_description_form"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
            <textarea id="panne_description_form" rows="3"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
              placeholder="Describe the issue..."></textarea>
          </div>
          <div>
            <label for="panne_date_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date
              Panne</label>
            <input type="datetime-local" id="panne_date_form" required
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
          </div>
          <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="cancelAddPanneModalButton"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" id="panneSubmitButton"
              class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
              <i data-lucide="plus-circle" class="w-4 h-4"></i> Ajout Panne
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Panne Record Modal -->
  <div id="viewPanneModal"
    class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div
      class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white">Details Panne</h3>
          <button id="closeViewPanneModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
            <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
          </button>
        </div>
        <div id="viewPanneDetails" class="space-y-3 text-sm">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 gap-y-2">
            <span class="view-detail-label sm:col-span-1">Panne ID:</span><span id="view-panne-id"
              class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Vehicule (Plaque):</span><span id="view-panne-vehicle"
              class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Categorie:</span><span id="view-panne-category"
              class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Description:</span><span id="view-panne-description"
              class="view-detail-value sm:col-span-2 whitespace-pre-wrap"></span>
            <span class="view-detail-label sm:col-span-1">Status:</span><span id="view-panne-status"
              class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Date Panne :</span><span id="view-panne-panne_date"
              class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Panne Declare A:</span><span id="view-panne-created_at"
              class="view-detail-value sm:col-span-2"></span>
          </div>
        </div>
        <div class="flex justify-end pt-6">
          <button type="button" id="closeViewPanneModalButtonBottom"
            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic Confirmation Modal -->
  <div id="genericConfirmModal"
    class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 id="genericConfirmModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Confirmer Action
          </h3>
          <button id="closeGenericConfirmModalButtonX"
            class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
            <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
          </button>
        </div>
        <p id="genericConfirmModalMessage" class="text-sm text-gray-600 dark:text-gray-400 mb-6">Etes vous sur?</p>
        <div class="flex justify-end gap-3 pt-4">
          <button id="cancelGenericConfirmModalButton"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button id="genericConfirmModalConfirmBtn"
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            Confirmer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Information/Status Modal -->
  <div id="infoStatusModal"
    class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
      <div class="p-6 text-center">
        <div id="infoStatusModalIconContainer"
          class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
        </div>
        <h3 id="infoStatusModalTitle" class="text-lg font-medium text-gray-900 dark:text-white mb-2">Status</h3>
        <div class="mt-2">
          <p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message.</p>
        </div>
        <div class="mt-5 sm:mt-6">
          <button type="button" id="infoStatusModalOkButton"
            class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">OK</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // --- Configuration ---
    const API_BASE_URL = '';
    const LOGIN_PAGE_URL = '/login';
    const VEHICLE_STATUS_OUT_OF_SERVICE = 'hors_service';

    // --- Authentication Helper ---
    function getAuthToken() { return localStorage.getItem('accessToken'); }
    function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { console.error("JWT Parse Error:", e); return null; } }

    function updateUserInfoDisplay() {
      const token = getAuthToken();
      const userDisplayElements = [document.getElementById('userDisplayNameHeader')];
      userDisplayElements.forEach(el => {
        if (!el) return;
        if (token) { const decoded = parseJwt(token); el.textContent = (decoded && decoded.sub) ? decoded.sub : 'User'; }
        else { el.textContent = 'Guest'; }
      });
    }

    async function apiRequest(endpoint, method = 'GET', body = null) {
      const token = getAuthToken();
      const headers = { 'Content-Type': 'application/json' };
      if (token) { headers['Authorization'] = `Bearer ${token}`; }
      else if (!endpoint.startsWith('/login')) { console.warn(`WARN: Protected endpoint ${endpoint} called without token.`); }
      const config = { method, headers };
      if (body) config.body = JSON.stringify(body);
      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
        if (response.status === 401 && !endpoint.endsWith('/login/')) { openInfoStatusModal("Authentication Error", "Session expired or unauthorized. Please log in again.", "error", 5000); return null; }
        if (response.status === 204) return true;
        const responseData = await response.json().catch(async () => {
          const text = await response.text();
          console.error(`JSON Parse Error for ${endpoint}. Status: ${response.status}. Response: ${text.substring(0, 100)}...`);
          if (!response.ok) return Promise.reject({ detail: text || `Server error ${response.status}` });
          throw new Error(`Invalid JSON response from server (status ${response.status}).`);
        });
        if (!response.ok) {
          const errorDetail = responseData.detail || JSON.stringify(responseData) || 'Unknown server error.';
          console.error(`API Error for ${endpoint}: ${response.status}`, errorDetail);
          if (!(response.status === 401 && endpoint.endsWith('/login/'))) {
            const errorMsg = Array.isArray(errorDetail) ? errorDetail.map(e => e.msg || e.detail).join(', ') : errorDetail;
            openInfoStatusModal(`API Error: ${response.status}`, errorMsg, "error");
          }
          return null;
        }
        return responseData;
      } catch (error) {
        console.error(`Network/Catch Error during API request to ${endpoint}:`, error);
        openInfoStatusModal("Request Error", error.detail || error.message || "A network or request error occurred.", "error");
        return null;
      }
    }

    // --- Global Variables ---
    let allPannes = [];
    const pannesPerPage = 10;
    let currentPannePage = 1;
    let panneToEditId = null;
    let activePanneDateFilter = 'all';
    let customPanneFilterStartDate = null;
    let customPanneFilterEndDate = null;
    let activePanneStatusFilter = '';
    let allVehiclesForDropdown = [];
    let allPanneCategoriesForDropdown = [];
    let currentConfirmAction = null;
    let currentActionData = null;
    let infoStatusModalTimeout = null;

    // --- Sidebar & Theme ---
    const sidebar = document.getElementById('sidebar'); const mobileMenuButton = document.getElementById('mobile-menu-button'); const sidebarCloseButton = document.getElementById('sidebar-close-button'); const sidebarOverlay = document.getElementById('sidebar-overlay'); const themeToggleButton = document.getElementById('theme-toggle-header'); function openMobileMenu() { if (sidebar && sidebarOverlay) { sidebar.classList.remove('-translate-x-full'); sidebar.classList.add('translate-x-0'); sidebarOverlay.classList.remove('hidden'); document.body.classList.add('overflow-hidden', 'md:overflow-auto'); } } function closeMobileMenu() { if (sidebar && sidebarOverlay) { sidebar.classList.add('-translate-x-full'); sidebar.classList.remove('translate-x-0'); sidebarOverlay.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); } } function setInitialThemeIcon() { if (themeToggleButton) { if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); themeToggleButton.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>'; } else { document.documentElement.classList.remove('dark'); themeToggleButton.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>'; } lucide.createIcons(); } } function toggleTheme() { if (document.documentElement.classList.contains('dark')) { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } else { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } setInitialThemeIcon(); }

    // --- Dashboard Widget Functions ---
    async function fetchAndDisplayPerformanceInsights() { const insightsList = document.getElementById('keyPerformanceInsightsList'); if (!insightsList) return; insightsList.innerHTML = `<li class="flex items-start space-x-2"><i data-lucide="loader-2" class="w-4 h-4 text-gray-400 animate-spin mt-0.5 shrink-0"></i><span>Loading insights...</span></li>`; lucide.createIcons(); const data = await apiRequest('/dashboard-data/performance-insights'); if (!data) { insightsList.innerHTML = `<li class="flex items-start space-x-2 text-red-500"><i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i><span>Failed to load insights.</span></li>`; lucide.createIcons(); return; } let insightsHTML = ''; const { fuel_efficiency, maintenance_compliance } = data; if (fuel_efficiency) { let trendColor = 'text-gray-500 dark:text-gray-400', trendText = 'steady'; if (fuel_efficiency.trend === 'up') { trendColor = 'text-green-500'; trendText = 'improving'; } else if (fuel_efficiency.trend === 'down') { trendColor = 'text-red-500'; trendText = 'worsening'; } const percentageText = fuel_efficiency.percentage_change !== null ? `(${fuel_efficiency.percentage_change > 0 ? '+' : ''}${fuel_efficiency.percentage_change}%)` : '(No prior data)'; insightsHTML += `<li class="flex items-start space-x-2"><i data-lucide="droplet" class="w-4 h-4 text-blue-500 mt-0.5 shrink-0"></i><div><span>Fuel Efficiency is <span class="${trendColor} font-semibold">${trendText}</span>.</span><span class="block text-gray-400 dark:text-gray-500 text-xs">Consumption vs last month ${percentageText}.</span></div></li>`; } if (maintenance_compliance) { insightsHTML += `<li class="flex items-start space-x-2"><i data-lucide="wrench" class="w-4 h-4 text-yellow-500 mt-0.5 shrink-0"></i><div><span><span class="font-semibold">${maintenance_compliance.total_maintenance_records}</span> maintenance records logged.</span><span class="block text-gray-400 dark:text-gray-500 text-xs">Total historical tasks.</span></div></li>`; } insightsList.innerHTML = insightsHTML || `<li>No performance data available.</li>`; lucide.createIcons(); }
    async function fetchAndDisplayAlerts() { const alertsList = document.getElementById('notificationsList'); const notificationCountSpan = document.getElementById('notificationCount'); if (!alertsList || !notificationCountSpan) return; alertsList.innerHTML = `<div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin mt-0.5 flex-shrink-0"></i><p class="text-xs text-gray-700 dark:text-gray-300">Loading alerts...</p></div>`; lucide.createIcons(); const data = await apiRequest('/dashboard-data/alerts'); if (!data) { alertsList.innerHTML = `<div class="flex items-start space-x-2 text-red-500"><i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i><p class="text-xs">Failed to load alerts.</p></div>`; notificationCountSpan.textContent = '0'; lucide.createIcons(); return; } notificationCountSpan.textContent = data.total_alerts || '0'; let alertsHTML = ''; const createAlertItemHTML = (alert, icon, colorClass) => { if (!alert) return ''; return `<div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="${icon}" class="w-5 h-5 ${colorClass} mt-0.5 flex-shrink-0"></i><div><p class="text-xs font-semibold text-gray-800 dark:text-gray-200">${alert.plate_number}</p><p class="text-xs text-gray-600 dark:text-gray-300">${alert.message}</p></div></div>`; }; alertsHTML += createAlertItemHTML(data.critical_panne, 'shield-alert', 'text-red-500'); alertsHTML += createAlertItemHTML(data.maintenance_alert, 'calendar-clock', 'text-blue-500'); alertsHTML += createAlertItemHTML(data.trip_alert, 'route', 'text-purple-500'); if (data.total_alerts === 0) { alertsHTML = `<div class="flex items-center justify-center text-center p-4"><div class="text-gray-500 dark:text-gray-400"><i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-green-500"></i><p class="text-xs">All clear! No new alerts.</p></div></div>`; } alertsList.innerHTML = alertsHTML; lucide.createIcons(); }
    async function initializeDashboardWidgets() { await Promise.all([fetchAndDisplayPerformanceInsights(), fetchAndDisplayAlerts()]); }

    // --- MODAL CONTROL ---
    function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); document.body.style.overflow = ''; }
    function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
    function closeAddPanneModal() { closeModal('addPanneModal'); panneToEditId = null; document.getElementById('addPanneForm').reset(); const submitButton = document.getElementById('panneSubmitButton'); if (submitButton) submitButton.disabled = false; }
    function closeViewPanneModal() { closeModal('viewPanneModal'); }
    function closeGenericConfirmModal() { closeModal('genericConfirmModal'); currentConfirmAction = null; currentActionData = null; }
    function closeInfoStatusModal() { if (infoStatusModalTimeout) { clearTimeout(infoStatusModalTimeout); infoStatusModalTimeout = null; } closeModal('infoStatusModal'); }
    function openGenericConfirmModal(title, message, confirmButtonText, confirmButtonIcon, onConfirmCallback, actionData = null) { document.getElementById('genericConfirmModalTitle').textContent = title; document.getElementById('genericConfirmModalMessage').textContent = message; const confirmBtn = document.getElementById('genericConfirmModalConfirmBtn'); confirmBtn.innerHTML = `<i data-lucide="${confirmButtonIcon || 'check-circle'}" class="w-4 h-4 mr-1"></i> ${confirmButtonText || 'Confirm'}`; confirmBtn.className = `px-4 py-2 text-white rounded-lg flex items-center gap-2 ${confirmButtonIcon === 'trash-2' ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}`; lucide.createIcons(); currentConfirmAction = onConfirmCallback; currentActionData = actionData; openModal('genericConfirmModal'); }
    function openInfoStatusModal(title, message, type = 'success', autoCloseDelay = 3000) { const titleEl = document.getElementById('infoStatusModalTitle'); const messageEl = document.getElementById('infoStatusModalMessage'); const iconContainer = document.getElementById('infoStatusModalIconContainer'); const okButton = document.getElementById('infoStatusModalOkButton'); titleEl.textContent = title; messageEl.textContent = message; if (infoStatusModalTimeout) clearTimeout(infoStatusModalTimeout); let iconName = 'info', iconColorClass = 'text-blue-600', bgColorClass = 'bg-blue-100', btnClass = 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500'; if (type === 'success') { iconName = 'check'; iconColorClass = 'text-green-600'; bgColorClass = 'bg-green-100'; btnClass = 'bg-green-600 hover:bg-green-700 focus:ring-green-500'; } else if (type === 'error') { iconName = 'x-circle'; iconColorClass = 'text-red-600'; bgColorClass = 'bg-red-100'; btnClass = 'bg-red-600 hover:bg-red-700 focus:ring-red-500'; } iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${bgColorClass} mb-4`; iconContainer.innerHTML = `<i data-lucide="${iconName}" class="h-6 w-6 ${iconColorClass}"></i>`; okButton.className = `inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white ${btnClass} focus:outline-none focus:ring-2 focus:ring-offset-2 sm:text-sm`; lucide.createIcons(); openModal('infoStatusModal'); if (autoCloseDelay > 0) { infoStatusModalTimeout = setTimeout(closeInfoStatusModal, autoCloseDelay); } }

    // --- DOMContentLoaded & Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons(); updateUserInfoDisplay(); themeToggleButton?.addEventListener('click', toggleTheme); setInitialThemeIcon(); mobileMenuButton?.addEventListener('click', openMobileMenu); sidebarCloseButton?.addEventListener('click', closeMobileMenu); sidebarOverlay?.addEventListener('click', closeMobileMenu); document.querySelectorAll('#sidebar nav a').forEach(link => { link.addEventListener('click', () => { if (window.innerWidth < 768) closeMobileMenu(); }); });
      ['addPanneModal', 'viewPanneModal', 'genericConfirmModal'].forEach(modalId => { document.getElementById(modalId)?.addEventListener('click', e => { if (e.target.id === modalId) closeModal(modalId); }); });
      document.getElementById('infoStatusModal')?.addEventListener('click', e => { if (e.target.id === 'infoStatusModal' || e.target.closest('#infoStatusModalOkButton')) closeInfoStatusModal(); });
      document.getElementById('closeAddPanneModalButtonTop')?.addEventListener('click', closeAddPanneModal);
      document.getElementById('cancelAddPanneModalButton')?.addEventListener('click', closeAddPanneModal);
      document.getElementById('closeViewPanneModalButtonTop')?.addEventListener('click', closeViewPanneModal);
      document.getElementById('closeViewPanneModalButtonBottom')?.addEventListener('click', closeViewPanneModal);
      document.getElementById('closeGenericConfirmModalButtonX')?.addEventListener('click', closeGenericConfirmModal);
      document.getElementById('cancelGenericConfirmModalButton')?.addEventListener('click', () => { closeGenericConfirmModal(); const submitBtn = document.getElementById('panneSubmitButton'); if (submitBtn) submitBtn.disabled = false; });
      document.getElementById('genericConfirmModalConfirmBtn')?.addEventListener('click', async () => { if (typeof currentConfirmAction === 'function') await currentConfirmAction(currentActionData); closeGenericConfirmModal(); });
      const handleLogout = (e) => { e.preventDefault(); localStorage.removeItem('accessToken'); openInfoStatusModal('Logged Out', 'You have been successfully logged out.', 'success', 2500); updateUserInfoDisplay(); allPannes = []; renderPannesTable(); document.getElementById('keyPerformanceInsightsList').innerHTML = `<li class="flex items-start space-x-2 text-gray-500"><i data-lucide="log-in" class="w-4 h-4 mt-0.5 shrink-0"></i><span>Please log in to see insights.</span></li>`; document.getElementById('notificationsList').innerHTML = `<div class="flex items-start space-x-2 text-gray-500 p-2.5"><i data-lucide="log-in" class="w-5 h-5 mt-0.5 shrink-0"></i><p class="text-xs">Please log in to see alerts.</p></div>`; document.getElementById('notificationCount').textContent = '0'; lucide.createIcons(); };
      document.getElementById('global-logout-btn')?.addEventListener('click', handleLogout);
      document.getElementById('openAddPanneModalButton')?.addEventListener('click', openAddPanneModal);
      document.getElementById('exportExcelButton')?.addEventListener('click', exportPannesExcel);
      document.getElementById('exportPdfButton')?.addEventListener('click', exportPannesPDF);
      document.getElementById('panneSearch')?.addEventListener('input', () => { currentPannePage = 1; renderPannesTable(); });
      document.getElementById('panneStatusFilter')?.addEventListener('change', (event) => applyPanneStatusFilter(event.target.value));
      document.getElementById('panne-date-filter-today')?.addEventListener('click', () => applyPanneDateFilter('today'));
      document.getElementById('panne-date-filter-last7')?.addEventListener('click', () => applyPanneDateFilter('last7days'));
      document.getElementById('panne-date-filter-last30')?.addEventListener('click', () => applyPanneDateFilter('last30days'));
      document.getElementById('panne-date-filter-all')?.addEventListener('click', () => applyPanneDateFilter('all'));
      document.getElementById('panne-date-filter-custom-btn')?.addEventListener('click', togglePanneCustomDateRange);
      document.getElementById('applyCustomDateFilterButton')?.addEventListener('click', applyPanneCustomDateFilter);
      document.getElementById('addPanneForm')?.addEventListener('submit', handlePanneFormSubmit);
      await initializePanneSection();
    });

    // --- Helpers & Initializers ---
    function getISODateString(date) { if (!date) return null; const d = new Date(date); return d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2); }
    function getISODateTimeString(date) { if (!date) return null; const d = new Date(date); return `${d.getFullYear()}-${('0' + (d.getMonth() + 1)).slice(-2)}-${('0' + d.getDate()).slice(-2)}T${('0' + d.getHours()).slice(-2)}:${('0' + d.getMinutes()).slice(-2)}`; }
    function getDateRange(filterType) { const today = new Date(); today.setHours(0, 0, 0, 0); let sD = new Date(today), eD = new Date(today); eD.setHours(23, 59, 59, 999); if (filterType === 'last7days') sD.setDate(today.getDate() - 6); else if (filterType === 'last30days') sD.setDate(today.getDate() - 29); else if (filterType === 'all') return { startDate: null, endDate: null }; return { startDate: getISODateString(sD), endDate: getISODateString(eD) }; }

    async function initializePanneSection() {
      await populatePanneLookupData();
      await fetchAndRenderPannes();
      if (getAuthToken()) await initializeDashboardWidgets();
      setActivePanneDateFilterButton('all');
      document.getElementById('panneStatusFilter').value = '';
    }

    async function populatePanneLookupData() {
      // UPDATED API ENDPOINTS - Fixed category endpoint
      [allVehiclesForDropdown, allPanneCategoriesForDropdown] = await Promise.all([
        apiRequest('/api/v1/vehicles/?limit=1000'),
        apiRequest('/api/v1/panne-categories/?limit=200')  // CHANGED THIS LINE
      ]);
      allVehiclesForDropdown = allVehiclesForDropdown?.items || allVehiclesForDropdown || [];
      allPanneCategoriesForDropdown = allPanneCategoriesForDropdown?.items || allPanneCategoriesForDropdown || [];
      populatePanneDropdowns();
    }

    function populatePanneDropdowns() {
      const populateSelect = (selectId, data, valueField, placeholder, textCallback) => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = `<option value="">${placeholder}</option>`;
        (data || []).forEach(item => {
          const option = new Option(textCallback(item), item[valueField]);
          select.appendChild(option);
        });
      };
      populateSelect('panne_vehicle_id_form', allVehiclesForDropdown, 'id', 'Select Vehicle', item => `${item.make || ''} ${item.model || ''} (${item.plate_number || 'N/A'})`.trim());
      populateSelect('panne_category_id_form', allPanneCategoriesForDropdown, 'id', 'Select Panne Category', item => item.panne_name || `ID: ${item.id}`);
    }

    // --- Filter Logic ---
    function applyPanneDateFilter(filterType) { activePanneDateFilter = filterType; customPanneFilterStartDate = null; customPanneFilterEndDate = null; document.getElementById('panneCustomDateRange').classList.add('hidden'); setActivePanneDateFilterButton(filterType); currentPannePage = 1; renderPannesTable(); }
    function togglePanneCustomDateRange() { document.getElementById('panneCustomDateRange').classList.toggle('hidden'); if (!document.getElementById('panneCustomDateRange').classList.contains('hidden')) setActivePanneDateFilterButton('panne-date-filter-custom-btn'); else if (activePanneDateFilter === 'custom') applyPanneDateFilter('all'); }
    function applyPanneCustomDateFilter() { const startDate = document.getElementById('panneCustomStartDate').value; const endDate = document.getElementById('panneCustomEndDate').value; if (!startDate || !endDate) { openInfoStatusModal("Input Error", "Please select both start and end dates.", "error"); return; } if (new Date(startDate) > new Date(endDate)) { openInfoStatusModal("Input Error", "Start date cannot be after end date.", "error"); return; } activePanneDateFilter = 'custom'; customPanneFilterStartDate = startDate; customPanneFilterEndDate = endDate; setActivePanneDateFilterButton('panne-date-filter-custom-btn'); currentPannePage = 1; renderPannesTable(); }
    function applyPanneStatusFilter(statusValue) { activePanneStatusFilter = statusValue; currentPannePage = 1; renderPannesTable(); }
    function setActivePanneDateFilterButton(filterId) { document.querySelectorAll('#panne-section .date-filter-btn').forEach(btn => btn.classList.remove('active')); const activeBtn = document.getElementById(filterId.startsWith('panne-date-filter-') ? filterId : `panne-date-filter-${filterId}`); if (activeBtn) activeBtn.classList.add('active'); }

    // --- CRUD & Table Rendering ---
    async function fetchAndRenderPannes() {
      if (!getAuthToken()) { allPannes = []; renderPannesTable(); return; }
      // UPDATED API ENDPOINT
      const data = await apiRequest(`/api/v1/pannes/?limit=1000`);
      allPannes = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
      renderPannesTable();
    }

    function getFilteredPannes() {
      let records = [...allPannes];
      if (activePanneStatusFilter) records = records.filter(p => p.status === activePanneStatusFilter);
      if (activePanneDateFilter !== 'all') {
        const range = (activePanneDateFilter === 'custom' && customPanneFilterStartDate && customPanneFilterEndDate) ? { startDate: customPanneFilterStartDate, endDate: customPanneFilterEndDate } : getDateRange(activePanneDateFilter);
        if (range.startDate && range.endDate) {
          records = records.filter(p => { const panneDate = getISODateString(new Date(p.panne_date)); return panneDate >= range.startDate && panneDate <= range.endDate; });
        }
      }
      const searchTerm = document.getElementById('panneSearch').value.toLowerCase();
      if (searchTerm) {
        records = records.filter(p => {
          const vehicleText = (p.vehicle ? `${p.vehicle.make || ''} ${p.vehicle.model || ''} ${p.vehicle.plate_number || ''}` : '').toLowerCase();
          const categoryText = (p.category_panne?.panne_name || '').toLowerCase();
          const statusText = (p.status || '').toLowerCase();
          return vehicleText.includes(searchTerm) || categoryText.includes(searchTerm) || statusText.includes(searchTerm);
        });
      }
      return records;
    }

    function renderPannesTable() {
      const pannesBody = document.getElementById('pannesBody');
      if (!getAuthToken()) {
        pannesBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-red-500">Please log in to view panne records.</td></tr>`;
        document.getElementById('pannesCount').textContent = '0 records';
        document.getElementById('pannesPagination').innerHTML = '';
        return;
      }

      const filteredRecords = getFilteredPannes();
      const totalRecords = filteredRecords.length;
      const totalPages = Math.ceil(totalRecords / pannesPerPage);
      if (currentPannePage > totalPages) currentPannePage = totalPages || 1;
      const start = (currentPannePage - 1) * pannesPerPage;
      const paginatedRecords = filteredRecords.slice(start, start + pannesPerPage);

      pannesBody.innerHTML = paginatedRecords.length > 0 ? paginatedRecords.map(p => {
        const isResolved = p.status.toLowerCase() === 'resolved';

        const vehicleDisplay = p.vehicle?.plate_number || 'N/A';
        const categoryDisplay = p.category_panne?.panne_name || 'N/A';
        const statusFormatted = p.status.charAt(0).toUpperCase() + p.status.slice(1).replace(/_/g, ' ');
        const statusColor = p.status === "active" ? "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200" : p.status === "in_progress" ? "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" : isResolved ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" : "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300";

        return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-id="${p.id}">
                <td class="py-3 px-2">${p.id}</td>
                <td class="px-2">${vehicleDisplay}</td>
                <td class="px-2">${categoryDisplay}</td>
                <td class="px-2"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${statusFormatted}</span></td>
                <td class="px-2">${new Date(p.panne_date).toLocaleDateString()}</td>
                <td class="px-2 text-center whitespace-nowrap">
                  <button onclick="openViewPanneModal(${p.id})" class="text-green-600 dark:text-green-400 p-1" title="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                  
                  <button onclick="openEditPanneModal(${p.id})" 
                          class="text-blue-600 dark:text-blue-400 p-1 ml-1 disabled:opacity-50 disabled:cursor-not-allowed" 
                          title="${isResolved ? 'Cannot edit a resolved issue' : 'Edit'}" 
                          ${isResolved ? 'disabled' : ''}>
                          <i data-lucide="edit-2" class="w-4 h-4"></i>
                  </button>

                  <button onclick="openConfirmDeletePanneModal(${p.id})" 
                          class="text-red-600 dark:text-red-400 p-1 ml-1 disabled:opacity-50 disabled:cursor-not-allowed" 
                          title="${isResolved ? 'Cannot delete a resolved issue' : 'Delete'}" 
                          ${isResolved ? 'disabled' : ''}>
                          <i data-lucide="trash-2" class="w-4 h-4"></i>
                  </button>
                </td>
              </tr>`;
      }).join('') : `<tr><td colspan="6" class="text-center py-8 text-gray-500">No panne records found matching your criteria.</td></tr>`;

      lucide.createIcons();
      const startRecord = totalRecords > 0 ? start + 1 : 0;
      const endRecord = start + paginatedRecords.length;
      document.getElementById('pannesCount').textContent = `Showing ${startRecord} to ${endRecord} of ${totalRecords} records`;
      renderPannesPagination(totalRecords);
    }

    function renderPannesPagination(totalRecords) { const totalPages = Math.ceil(totalRecords / pannesPerPage); const paginationContainer = document.getElementById('pannesPagination'); paginationContainer.innerHTML = ''; if (totalPages <= 1) return; const btnClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500"; const itemClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"; const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed"; const prevButton = Object.assign(document.createElement('button'), { innerHTML: `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`, className: `${btnClasses} ${currentPannePage === 1 ? disabledClasses : itemClasses}`, disabled: currentPannePage === 1, onclick: () => { if (currentPannePage > 1) { currentPannePage--; renderPannesTable(); } } }); const pageInfo = Object.assign(document.createElement('span'), { className: "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400", textContent: `Page ${currentPannePage} of ${totalPages}` }); const nextButton = Object.assign(document.createElement('button'), { innerHTML: `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`, className: `${btnClasses} ${currentPannePage >= totalPages ? disabledClasses : itemClasses}`, disabled: currentPannePage >= totalPages, onclick: () => { if (currentPannePage < totalPages) { currentPannePage++; renderPannesTable(); } } }); paginationContainer.append(prevButton, pageInfo, nextButton); lucide.createIcons(); }

    // --- Modal & Form Handling ---
    function openAddPanneModal() { if (!getAuthToken()) { openInfoStatusModal("Authentication Required", "Please log in to add a panne record.", "error"); return; } panneToEditId = null; document.getElementById('addPanneForm').reset(); document.getElementById('panneModalTitle').textContent = "Add New Panne (Issue)"; document.getElementById('panneSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i> Add Panne`; document.getElementById('panneSubmitButton').disabled = false; document.getElementById('panne_date_form').value = getISODateTimeString(new Date()); lucide.createIcons(); openModal('addPanneModal'); }
    async function openEditPanneModal(id) { if (!getAuthToken()) { openInfoStatusModal("Authentication Required", "Please log in to edit.", "error"); return; } const panne = await apiRequest(`/api/v1/pannes/${id}`); if (!panne) { openInfoStatusModal("Error", "Could not fetch panne details.", "error"); return; } panneToEditId = id; document.getElementById('panneModalTitle').textContent = "Edit Panne (Issue) Record"; document.getElementById('panneSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4 mr-1"></i> Save Changes`; document.getElementById('panneSubmitButton').disabled = false; document.getElementById('panneId_form').value = panne.id; document.getElementById('panne_vehicle_id_form').value = panne.vehicle_id; document.getElementById('panne_category_id_form').value = panne.category_panne_id; document.getElementById('panne_description_form').value = panne.description || ''; document.getElementById('panne_date_form').value = getISODateTimeString(new Date(panne.panne_date)); lucide.createIcons(); openModal('addPanneModal'); }
    async function openViewPanneModal(id) { if (!getAuthToken()) { openInfoStatusModal("Authentication Required", "Please log in to view.", "error"); return; } const panne = await apiRequest(`/api/v1/pannes/${id}`); if (!panne) { openInfoStatusModal("Error", "Could not fetch panne details.", "error"); return; } const vehicleDisplay = panne.vehicle?.plate_number || 'N/A'; const categoryDisplay = panne.category_panne?.panne_name || 'N/A'; document.getElementById('view-panne-id').textContent = panne.id; document.getElementById('view-panne-vehicle').textContent = vehicleDisplay; document.getElementById('view-panne-category').textContent = categoryDisplay; document.getElementById('view-panne-description').textContent = panne.description || 'N/A'; document.getElementById('view-panne-status').textContent = panne.status.charAt(0).toUpperCase() + panne.status.slice(1).replace(/_/g, ' '); document.getElementById('view-panne-panne_date').textContent = new Date(panne.panne_date).toLocaleString(); document.getElementById('view-panne-created_at').textContent = new Date(panne.created_at).toLocaleString(); openModal('viewPanneModal'); }

    async function handlePanneFormSubmit(event) {
      event.preventDefault();
      if (!getAuthToken()) { openInfoStatusModal("Authentication Required", "Please log in.", "error"); return; }
      const submitButton = document.getElementById('panneSubmitButton');
      if (submitButton.disabled) return;
      submitButton.disabled = true;

      const panneDateValue = document.getElementById('panne_date_form').value;
      if (!panneDateValue) { openInfoStatusModal("Validation Error", "Panne Date is required.", "error"); submitButton.disabled = false; return; }
      const panneDateTime = new Date(panneDateValue);
      if (isNaN(panneDateTime.getTime()) || panneDateTime > new Date()) { openInfoStatusModal("Validation Error", "A valid Panne Date that is not in the future is required.", "error"); submitButton.disabled = false; return; }

      const formData = {
        vehicle_id: parseInt(document.getElementById('panne_vehicle_id_form').value),
        category_panne_id: parseInt(document.getElementById('panne_category_id_form').value),
        description: document.getElementById('panne_description_form').value.trim() || null,
        panne_date: panneDateTime.toISOString()
      };

      const isNewRecord = !panneToEditId;
      if (isNewRecord) {
        formData.status = 'active';
      }

      if (!formData.vehicle_id || !formData.category_panne_id) {
        openInfoStatusModal("Validation Error", "Vehicle and Category are required.", "error");
        submitButton.disabled = false; return;
      }

      const actionType = isNewRecord ? "add" : "update";
      openGenericConfirmModal(
        isNewRecord ? "Confirm Add Panne" : "Confirm Update", `Are you sure you want to ${actionType} this panne record?`,
        isNewRecord ? "Add" : "Update", isNewRecord ? "plus-circle" : "save",
        async (data) => {
          try {
            // UPDATED API ENDPOINTS
            const panneResult = isNewRecord ? await apiRequest('/api/v1/pannes/', 'POST', data) : await apiRequest(`/api/v1/pannes/${panneToEditId}`, 'PUT', data);

            if (panneResult) {
              if (isNewRecord && data.status === 'active') {
                console.log(`New 'active' panne created. Updating status for vehicle ID: ${data.vehicle_id}.`);

                const vehicleStatusPayload = { status: VEHICLE_STATUS_OUT_OF_SERVICE };

                // UPDATED API ENDPOINT
                const vehicleUpdateResult = await apiRequest(`/api/v1/vehicles/${data.vehicle_id}/status`, 'PATCH', vehicleStatusPayload);

                if (vehicleUpdateResult) {
                  openInfoStatusModal("Success", `Panne created & vehicle status updated to 'Out of Service'!`, "success");
                } else {
                  openInfoStatusModal("Partial Success", "Panne record was created, but the vehicle's status could not be updated. Please check it manually.", "error", 5000);
                }
              } else {
                openInfoStatusModal("Success", `Panne record updated successfully!`, "success");
              }
              closeAddPanneModal();
              await fetchAndRenderPannes();
            } else {
              if (submitButton) submitButton.disabled = false;
            }
          } catch (error) {
            console.error(`Error during ${actionType} panne record:`, error);
            if (submitButton) submitButton.disabled = false;
          }
        },
        formData
      );
    }

    function openConfirmDeletePanneModal(id) { if (!getAuthToken()) { openInfoStatusModal("Authentication Required", "Please log in to delete.", "error"); return; } openGenericConfirmModal("Confirm Deletion", `Are you sure you want to permanently delete panne record ID: ${id}?`, "Delete", "trash-2", async (recordIdToDelete) => { const result = await apiRequest(`/api/v1/pannes/${recordIdToDelete}`, 'DELETE'); if (result === true) { openInfoStatusModal("Success", `Panne record ID: ${recordIdToDelete} deleted.`, "success"); currentPannePage = 1; await fetchAndRenderPannes(); } }, id); }

    // --- Export Functions ---
    function exportPannesExcel() {
      if (!getAuthToken()) { openInfoStatusModal("Export Error", "Please log in to export data.", "error"); return; }
      const recordsToExport = getFilteredPannes();
      if (!recordsToExport || recordsToExport.length === 0) { openInfoStatusModal("Info", "No data to export based on current filters.", "info"); return; }
      const data = recordsToExport.map(p => ({
        ID: p.id,
        'Vehicle (Plate)': p.vehicle?.plate_number || 'N/A',
        Category: p.category_panne?.panne_name || 'N/A',
        Description: p.description || '',
        Status: p.status,
        'Panne Date': new Date(p.panne_date).toLocaleString(),
        'Reported At': new Date(p.created_at).toLocaleString()
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Pannes");
      XLSX.writeFile(wb, "pannes_issues_export.xlsx");
      openInfoStatusModal("Success", "Data exported to Excel.", "success");
    }

    function exportPannesPDF() {
      if (!getAuthToken()) { openInfoStatusModal("Export Error", "Please log in to export data.", "error"); return; }
      const recordsToExport = getFilteredPannes();
      if (!recordsToExport || recordsToExport.length === 0) { openInfoStatusModal("Info", "No data to export based on current filters.", "info"); return; }
      const { jsPDF } = window.jspdf; const doc = new jsPDF('l'); doc.setFontSize(18); doc.text('Panne (Issue) Records', 14, 15);
      const headers = [['ID', 'Vehicle (Plate)', 'Category', 'Status', 'Panne Date', 'Description']];
      const data = recordsToExport.map(p => [p.id, p.vehicle?.plate_number || 'N/A', p.category_panne?.panne_name || 'N/A', p.status, new Date(p.panne_date).toLocaleDateString(), (p.description || '').substring(0, 50)]);
      doc.autoTable({ head: headers, body: data, startY: 25, theme: 'grid', headStyles: { fillColor: [220, 53, 69], textColor: 255 }, columnStyles: { 0: { cellWidth: 15 }, 1: { cellWidth: 40 }, 2: { cellWidth: 40 }, 3: { cellWidth: 30 }, 4: { cellWidth: 30 }, 5: { cellWidth: 80 } } });
      doc.save('pannes_issues_export.pdf');
      openInfoStatusModal("Success", "Data exported to PDF.", "success");
    }

  </script>
  <script src="/static/js/global.js"></script>
</body>

</html>