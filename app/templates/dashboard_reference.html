<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Management | SuperAdmin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- General and Layout Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary: #3498db; --secondary: #2c3e50; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --info: #17a2b8; --light: #f8f9fa; --dark: #343a40; --gray: #6c757d; --sidebar-width: 250px; --header-height: 70px; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, var(--secondary) 0%, #1a2530 100%); color: white; height: 100vh; position: fixed; overflow-y: auto; transition: all 0.3s; z-index: 1000; display: flex; flex-direction: column; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 20px; transition: all 0.3s; }
        
        /* --- Sidebar Styles --- */
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header h2 { font-size: 1.5rem; margin-bottom: 5px; }
        .sidebar-header p { font-size: 0.8rem; opacity: 0.7; }
        .sidebar-menu { padding: 15px 0; flex: 1; }
        .menu-item { padding: 12px 20px; display: flex; align-items: center; color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; }
        .menu-item:hover, .menu-item.active { background-color: rgba(255, 255, 255, 0.1); color: white; border-left-color: var(--primary); }
        .menu-item i { margin-right: 10px; width: 20px; text-align: center; }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .logout-btn { width: 100%; padding: 12px; background-color: rgba(231, 76, 60, 0.2); color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .logout-btn:hover { background-color: rgba(231, 76, 60, 0.4); }
        .logout-btn i { margin-right: 8px; }

        /* --- Header & User Info Styles --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
        .header h1 { color: var(--secondary); font-size: 1.8rem; }
        .user-info { display: flex; align-items: center; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; border: 2px solid var(--primary); }

        /* --- Stats Cards Styles --- */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; transition: transform 0.3s, box-shadow 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .stat-icon { width: 60px; height: 60px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 24px; }
        .stat-info h3 { font-size: 1.8rem; margin-bottom: 5px; }
        .stat-info p { color: var(--gray); font-size: 0.9rem; }
        .bg-primary { background-color: rgba(52, 152, 219, 0.2); color: var(--primary); }
        .bg-success { background-color: rgba(46, 204, 113, 0.2); color: var(--success); }
        .bg-warning { background-color: rgba(243, 156, 18, 0.2); color: var(--warning); }
        .bg-danger { background-color: rgba(231, 76, 60, 0.2); color: var(--danger); }
        .bg-info { background-color: rgba(23, 162, 184, 0.2); color: var(--info); }

        /* --- Action Button Styles --- */
        .quick-actions { display: flex; gap: 15px; margin-bottom: 30px; }
        .action-btn { padding: 12px 20px; background: white; border: none; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: flex; align-items: center; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .action-btn i { margin-right: 8px; font-size: 16px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }

        /* --- Table Styles --- */
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .table-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; }
        .table-header h2 { color: var(--secondary); }
        .table-actions { display: flex; gap: 10px; }
        .search-box { position: relative; }
        .search-box input { padding: 8px 15px 8px 35px; border: 1px solid #e0e0e0; border-radius: 5px; width: 250px; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8f9fa; }
        .status { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; text-transform: capitalize; }
        .status-pending { background-color: rgba(243, 156, 18, 0.2); color: var(--warning); }
        .status-fully_approved, .status-completed, .status-in_progress { background-color: rgba(46, 204, 113, 0.2); color: var(--success); }
        .status-denied { background-color: rgba(231, 76, 60, 0.2); color: var(--danger); }
        .action-btns { display: flex; gap: 8px; }
        .btn-action { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; }
        .btn-view { background-color: rgba(52, 152, 219, 0.2); color: var(--primary); }
        .btn-view:hover { background-color: var(--primary); color: white; }
        .btn-delete { background-color: rgba(231, 76, 60, 0.2); color: var(--danger); }
        .btn-delete:hover { background-color: var(--danger); color: white; }
        .pagination-container { padding: 20px; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .page-btn { padding: 8px 14px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: white; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .page-btn:hover:not(:disabled) { background-color: var(--primary); color: white; border-color: var(--primary); }
        .page-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:disabled { background-color: #f8f9fa; color: var(--gray); cursor: not-allowed; }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal-content { background: white; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); animation: slideIn 0.3s ease; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { color: var(--secondary); }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
        .modal-body { padding: 25px; }
        .request-details, .request-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 30px; }
        .detail-group { margin-bottom: 5px; }
        .detail-group-full { grid-column: 1 / -1; }
        .detail-label { font-weight: 600; color: var(--secondary); margin-bottom: 8px; display: block; font-size: 0.9rem; }
        .detail-value { padding: 10px 12px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0; width: 100%; font-size: 0.95rem; color: #333; }
        .detail-value:disabled { background-color: #e9ecef; cursor: not-allowed; }
        div.detail-value { border-left: 3px solid var(--primary); }
        .detail-value:not(select):not(input):not(textarea) { background-color: #f0f2f5; color: #555; }
        .modal-footer { padding: 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px; background-color: #f8f9fa; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .btn i { margin-right: 8px; }
        .btn-cancel { background-color: #e0e0e0; color: var(--secondary); }
        .btn-cancel:hover { background-color: #c9c9c9; }
        .btn-update-modal { background-color: var(--info); color: white; }
        .btn-approve-modal { background-color: var(--success); color: white; }
        .btn-deny-modal { background-color: var(--danger); color: white; }
        .btn-save-modal { background-color: var(--success); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        
        #confirmationModal .modal-content { max-width: 420px; }
        #confirmationModal .modal-header { display: flex; align-items: center; gap: 12px; }
        #confirmationModal .modal-icon { font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        #confirmationModal .modal-icon.success { background-color: rgba(46, 204, 113, 0.2); color: var(--success); }
        #confirmationModal .modal-icon.danger { background-color: rgba(231, 76, 60, 0.2); color: var(--danger); }
        #confirmationModal .modal-icon.warning { background-color: rgba(243, 156, 18, 0.2); color: var(--warning); }
        #confirmationModal .modal-body { text-align: center; font-size: 1rem; color: var(--secondary); }
        #confirmationModal .modal-footer { justify-content: center; }
        #confirmBtn.danger { background-color: var(--danger); }
        #confirmBtn.success { background-color: var(--success); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Fleet Management</h2>
            <p>SuperAdmin Dashboard</p>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item active">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </div>
        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>SuperAdmin Dashboard</h1>
            <div class="user-info">
                <img src="https://ui-avatars.com/api/?name=Super+Admin&background=e74c3c&color=fff" alt="Super Admin">
                <div>
                    <div>Super Admin</div>
                    <small>Administrator</small>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon bg-warning"> <i class="fas fa-clock"></i> </div>
                <div class="stat-info"> <h3 id="pending-count">0</h3> <p>Pending Requests</p> </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bg-success"> <i class="fas fa-check-circle"></i> </div>
                <div class="stat-info"> <h3 id="approved-count">0</h3> <p>Approved Requests</p> </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bg-danger"> <i class="fas fa-times-circle"></i> </div>
                <div class="stat-info"> <h3 id="denied-count">0</h3> <p>Denied Requests</p> </div>
            </div>
        </div>

        <div class="quick-actions">
            <button class="action-btn btn-primary" id="refreshBtn"> <i class="fas fa-sync-alt"></i> Refresh Requests </button>
            <button class="action-btn btn-success" id="addRequestBtn"> <i class="fas fa-plus"></i> Add New Request </button>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h2>All Vehicle Requests</h2>
                <div class="table-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search requests...">
                    </div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Requester</th>
                        <th>Assigned Vehicle</th>
                        <th>Assigned Driver</th>
                        <th>From - To</th>
                        <th>Date & Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="requestTableBody"></tbody>
            </table>
            <div class="pagination-container" id="pagination"></div>
        </div>
    </div>

    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Request Details</h2>
                <button class="close-btn" id="closeDetailsModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="request-details">
                    <div class="detail-group"> <span class="detail-label">Requester</span> <div class="detail-value" id="detailRequester">-</div> </div>
                    <div class="detail-group"> <span class="detail-label">Service / Department</span> <div class="detail-value" id="detailDepartment">-</div> </div>
                    <div class="detail-group"> <span class="detail-label">From</span> <div class="detail-value" id="detailFrom">-</div> </div>
                    <div class="detail-group"> <span class="detail-label">To</span> <div class="detail-value" id="detailTo">-</div> </div>
                    <div class="detail-group"> <span class="detail-label">Date</span> <div class="detail-value" id="detailDate">-</div> </div>
                    <div class="detail-group"> <span class="detail-label">Timings</span> <div class="detail-value" id="detailTimings">-</div> </div>
                    <div class="detail-group"> <span class="detail-label">Assign Vehicle</span> <select class="detail-value" id="detailVehicle"></select> </div>
                    <div class="detail-group"> <span class="detail-label">Assign Driver</span> <select class="detail-value" id="detailDriver"></select> </div>
                    <div class="detail-group detail-group-full"> <span class="detail-label">Purpose of Journey</span> <div class="detail-value" id="detailPurpose" style="min-height: 60px;">-</div> </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" id="cancelDetailsModalBtn">Close</button>
                <button type="button" class="btn btn-update-modal" id="updateRequestBtn"> <i class="fas fa-save"></i>Update Assignment </button>
                <button type="button" class="btn btn-deny-modal" id="denyRequestBtn"> <i class="fas fa-times"></i>Deny </button>
                <button type="button" class="btn btn-approve-modal" id="approveRequestBtn"> <i class="fas fa-check"></i>Approve </button>
            </div>
        </div>
    </div>

    <div class="modal" id="addRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Vehicle Request</h2>
                <button class="close-btn" id="closeAddModalBtn">&times;</button>
            </div>
            <form id="addRequestForm" novalidate>
                <div class="modal-body">
                    <div class="request-form-grid">
                        <div class="detail-group detail-group-full">
                            <label for="purpose" class="detail-label">Purpose of Journey *</label>
                            <textarea id="purpose" name="purpose" class="detail-value" rows="3" required></textarea>
                        </div>
                        <div class="detail-group">
                            <label for="from_location" class="detail-label">From Location *</label>
                            <input type="text" id="from_location" name="from_location" class="detail-value" required>
                        </div>
                        <div class="detail-group">
                            <label for="to_location" class="detail-label">To Location *</label>
                            <input type="text" id="to_location" name="to_location" class="detail-value" required>
                        </div>
                        <div class="detail-group">
                            <label for="departure_time" class="detail-label">Departure Time *</label>
                            <input type="datetime-local" id="departure_time" name="departure_time" class="detail-value" required>
                        </div>
                        <div class="detail-group">
                            <label for="return_time" class="detail-label">Return Time *</label>
                            <input type="datetime-local" id="return_time" name="return_time" class="detail-value" required>
                        </div>
                        <div class="detail-group">
                            <label for="addVehicleSelect" class="detail-label">Assign Vehicle (Optional)</label>
                            <select id="addVehicleSelect" name="vehicle_id" class="detail-value" disabled>
                                <option value="">Assign later by viewing the request</option>
                            </select>
                        </div>
                        <div class="detail-group">
                            <label for="addDriverSelect" class="detail-label">Assign Driver (Optional)</label>
                            <select id="addDriverSelect" name="driver_id" class="detail-value" disabled>
                                <option value="">Assign later by viewing the request</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="cancelAddModalBtn">Cancel</button>
                    <button type="submit" class="btn btn-save-modal" id="saveRequestBtn"> <i class="fas fa-save"></i> Save Request </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div id="confirmModalIcon" class="modal-icon"></div>
                <h2 id="confirmModalTitle"></h2>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                <button type="button" class="btn" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = 'http://127.0.0.1:8000';
    
        // --- GLOBAL STATE ---
        let allRequests = [];
        let filteredRequests = [];
        let currentRequest = null;
        let currentPage = 1;
        
        // --- HOW TO TEST PAGINATION ---
        // Change this number to a small value (like 2 or 3) to see the pagination
        // controls appear even if you only have a few requests.
        const rowsPerPage = 5;
    
        // --- DOM ELEMENTS ---
        const requestTableBody = document.getElementById('requestTableBody');
        const paginationContainer = document.getElementById('pagination');
        const searchInput = document.getElementById('searchInput');
        const requestModal = document.getElementById('requestModal');
        const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
        const cancelDetailsModalBtn = document.getElementById('cancelDetailsModalBtn');
        const updateRequestBtn = document.getElementById('updateRequestBtn');
        const denyRequestBtn = document.getElementById('denyRequestBtn');
        const approveRequestBtn = document.getElementById('approveRequestBtn');
        const addRequestModal = document.getElementById('addRequestModal');
        const addRequestBtn = document.getElementById('addRequestBtn');
        const addRequestForm = document.getElementById('addRequestForm');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddModalBtn = document.getElementById('cancelAddModalBtn');
        const saveRequestBtn = document.getElementById('saveRequestBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalIcon = document.getElementById('confirmModalIcon');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const departureTimeInput = document.getElementById('departure_time');
        const returnTimeInput = document.getElementById('return_time');

        // --- HELPER FUNCTIONS ---
        const getToken = () => {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                showConfirmationModal('Authentication Error', 'Authentication token not found. Please log in.', {
                    type: 'danger', confirmText: 'Go to Login',
                    onConfirm: () => { window.location.href = '/login.html'; }
                });
                return null;
            }
            return token;
        };
    
        const apiRequest = async (endpoint, method = 'GET', body = null) => {
            const token = getToken();
            if (!token) return null;
    
            const headers = new Headers({
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            });
    
            const config = { method, headers };
            if (body) {
                config.body = JSON.stringify(body);
            }
    
            try {
                const cleanEndpoint = `/${endpoint.replace(/^\//, '')}`;
                const response = await fetch(`${API_BASE_URL}${cleanEndpoint}`, config);
                
                if (response.status === 401) {
                    localStorage.clear();
                    showConfirmationModal('Session Expired', 'Your session is invalid. Please log in again.', {
                        type: 'warning', confirmText: 'Go to Login',
                        onConfirm: () => { window.location.href = '/login.html'; }
                    });
                    return null;
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 422 && Array.isArray(errorData.detail)) {
                        const errorMessages = errorData.detail.map(err => `Error on field '${err.loc[1]}': ${err.msg}`).join('\n');
                        throw new Error(errorMessages);
                    }
                    throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
                }
    
                if (response.status === 204) {
                    return { success: true };
                }
                return await response.json();
            } catch (error) {
                console.error(`API Error on ${method} ${endpoint}:`, error);
                showConfirmationModal('API Error', error.message, { type: 'danger', confirmText: 'OK' });
                return null;
            }
        };
    
        const populateSelect = (selectElement, items, valueField, defaultOptionText) => {
             selectElement.innerHTML = `<option value="">-- ${defaultOptionText} --</option>`;
             if (!items || !Array.isArray(items)) return;
             items.forEach(item => {
                 const option = document.createElement('option');
                 option.value = item[valueField];
                 
                 let displayText = '';
                 if (item.first_name || item.last_name) {
                     displayText = `${item.first_name || ''} ${item.last_name || ''}`.trim();
                 } else if (item.plate_number) {
                     const make = item.make_ref?.vehicle_make || item.make || '';
                     const model = item.model_ref?.vehicle_model || item.model || '';
                     displayText = `${make} ${model} (${item.plate_number})`.trim();
                 }
                 option.textContent = displayText;
                 selectElement.appendChild(option);
             });
        };
        
        let confirmCallback = null;
        
        const showConfirmationModal = (title, message, options = {}) => {
            const { type = 'warning', confirmText = 'Confirm', onConfirm = null } = options;
            confirmModalTitle.textContent = title;
            confirmModalMessage.innerHTML = message.replace(/\n/g, '<br>');
            confirmModalIcon.className = 'modal-icon';
            confirmBtn.className = 'btn';
            
            if (type === 'danger') {
                confirmModalIcon.innerHTML = `<i class="fas fa-times-circle"></i>`;
                confirmModalIcon.classList.add('danger');
                confirmBtn.classList.add('danger');
            } else if (type === 'success') {
                confirmModalIcon.innerHTML = `<i class="fas fa-check-circle"></i>`;
                confirmModalIcon.classList.add('success');
                confirmBtn.classList.add('success');
            } else {
                confirmModalIcon.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`;
                confirmModalIcon.classList.add('warning');
                confirmBtn.classList.add('btn-primary');
            }
            
            confirmBtn.textContent = confirmText;
            confirmCallback = onConfirm;
            cancelBtn.style.display = onConfirm ? 'inline-flex' : 'none';
            confirmBtn.style.display = 'inline-flex';
            confirmationModal.style.display = 'flex';
        };

        const hideConfirmationModal = () => {
            confirmationModal.style.display = 'none';
            confirmCallback = null;
        };

        // --- CORE LOGIC ---
        const fetchAndRenderAllData = async () => {
            const data = await apiRequest('requests/');
            if (data) {
                allRequests = data;
                filteredRequests = data;
                currentPage = 1;
                updatePage();
                updateStats();
            }
        };
    
        const updateStats = () => {
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'fully_approved' || r.status === 'completed').length;
            const denied = allRequests.filter(r => r.status === 'denied').length;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('denied-count').textContent = denied;
        };
    
        const populateRequestTable = () => {
            requestTableBody.innerHTML = '';
            if (!filteredRequests || filteredRequests.length === 0) {
                 requestTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">No requests found.</td></tr>';
                 return;
            }

            const startIndex = (currentPage - 1) * rowsPerPage;
            const paginatedRequests = filteredRequests.slice(startIndex, startIndex + rowsPerPage);
            
            paginatedRequests.forEach((req, index) => {
                const row = document.createElement('tr');
                const requesterName = req.requester ? `${req.requester.first_name} ${req.requester.last_name}` : 'N/A';
                
                // --- THE FIX: Use plate_number as it is guaranteed to be in the list view response ---
                const vehicleName = req.vehicle ? req.vehicle.plate_number : 'Not Assigned';
                // --- END OF FIX ---

                const driverName = req.driver ? `${req.driver.first_name} ${req.driver.last_name}`.trim() : 'Not Assigned';
                const statusClass = `status-${req.status.replace(/\s+/g, '_').toLowerCase()}`;
    
                row.innerHTML = `
                    <td data-label="#">${startIndex + index + 1}</td>
                    <td data-label="Requester">${requesterName}</td>
                    <td data-label="Assigned Vehicle">${vehicleName}</td>
                    <td data-label="Assigned Driver">${driverName}</td>
                    <td data-label="From - To">${req.from_location} → ${req.to_location}</td>
                    <td data-label="Date & Time">
                        <div>${new Date(req.departure_time).toLocaleDateString()}</div>
                        <small style="color: var(--gray);">${new Date(req.departure_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} → ${new Date(req.return_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                    </td>
                    <td data-label="Status"><span class="status ${statusClass}">${req.status.replace('_', ' ')}</span></td>
                    <td data-label="Actions">
                        <div class="action-btns">
                            <button class="btn-action btn-view" data-id="${req.id}"><i class="fas fa-eye"></i> View</button>
                            <button class="btn-action btn-delete" data-id="${req.id}"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </td>
                `;
                requestTableBody.appendChild(row);
            });
        };
    
        const setupPagination = () => {
            paginationContainer.innerHTML = '';
            const pageCount = Math.ceil(filteredRequests.length / rowsPerPage);
            if (pageCount <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.classList.add('page-btn');
            prevButton.innerHTML = '&laquo;';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; updatePage(); } });
            paginationContainer.appendChild(prevButton);

            for (let i = 1; i <= pageCount; i++) {
                const pageButton = document.createElement('button');
                pageButton.classList.add('page-btn');
                pageButton.textContent = i;
                if (i === currentPage) pageButton.classList.add('active');
                pageButton.addEventListener('click', () => { currentPage = i; updatePage(); });
                paginationContainer.appendChild(pageButton);
            }
            
            const nextButton = document.createElement('button');
            nextButton.classList.add('page-btn');
            nextButton.innerHTML = '&raquo;';
            nextButton.disabled = currentPage === pageCount;
            nextButton.addEventListener('click', () => { if (currentPage < pageCount) { currentPage++; updatePage(); } });
            paginationContainer.appendChild(nextButton);
        };
    
        const updatePage = () => {
            populateRequestTable();
            setupPagination();
        };
    
        const showRequestDetails = async (requestId) => {
            currentRequest = await apiRequest(`requests/${requestId}`);
            if (!currentRequest) return;
            const [vehicles, drivers] = await Promise.all([apiRequest('vehicle/'), apiRequest('user/by_role/driver')]);
            if (vehicles) populateSelect(document.getElementById('detailVehicle'), vehicles, 'id', 'Select a Vehicle');
            if (drivers) populateSelect(document.getElementById('detailDriver'), drivers, 'id', 'Select a Driver');
            document.getElementById('modal-title').textContent = `Request Details (REQ-${String(currentRequest.id).padStart(4, '0')})`;
            document.getElementById('detailRequester').textContent = `${currentRequest.requester?.first_name} ${currentRequest.requester?.last_name}` || 'N/A';
            document.getElementById('detailDepartment').textContent = currentRequest.requester?.service?.service_name || 'N/A';
            document.getElementById('detailFrom').textContent = currentRequest.from_location;
            document.getElementById('detailTo').textContent = currentRequest.to_location;
            document.getElementById('detailDate').textContent = new Date(currentRequest.departure_time).toLocaleDateString();
            document.getElementById('detailTimings').textContent = `${new Date(currentRequest.departure_time).toLocaleTimeString()} - ${new Date(currentRequest.return_time).toLocaleTimeString()}`;
            document.getElementById('detailPurpose').textContent = currentRequest.purpose;
            document.getElementById('detailVehicle').value = currentRequest.vehicle?.id || '';
            document.getElementById('detailDriver').value = currentRequest.driver?.id || '';
            const isPending = currentRequest.status === 'pending';
            approveRequestBtn.style.display = isPending ? 'flex' : 'none';
            denyRequestBtn.style.display = isPending ? 'flex' : 'none';
            updateRequestBtn.style.display = isPending ? 'flex' : 'none';
            requestModal.style.display = 'flex';
        };
    
        const closeDetailsModal = () => {
            requestModal.style.display = 'none';
            currentRequest = null;
        };
    
        const handleUpdateRequest = async () => {
            if (!currentRequest) return;
            const vehicleId = document.getElementById('detailVehicle').value;
            const driverId = document.getElementById('detailDriver').value;
            const updateData = {
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                driver_id: driverId ? parseInt(driverId) : null,
            };
            const result = await apiRequest(`requests/${currentRequest.id}`, 'PUT', updateData);
            if (result) {
                showConfirmationModal('Success', 'Request assignments have been updated successfully.', { type: 'success', confirmText: 'OK' });
                closeDetailsModal();
                fetchAndRenderAllData();
            }
        };

        const handleApprovalAction = async (action) => {
            if (!currentRequest || currentRequest.status !== 'pending') return;
            const pendingApproval = currentRequest.approvals.find(appr => appr.status === 'pending');
            if (!pendingApproval) {
                return showConfirmationModal('Error', 'No pending approval step found for this request.', { type: 'danger', confirmText: 'OK' });
            }
            if (action === 'approved' && !document.getElementById('detailDriver').value) {
                return showConfirmationModal('Warning', 'Please assign a driver before approving.', { confirmText: 'OK' });
            }
            const performAction = async () => {
                const result = await apiRequest(`approvals/${pendingApproval.id}`, 'PUT', { status: action, comments: `Actioned by SuperAdmin` });
                if (result) {
                    showConfirmationModal('Success', `Request has been ${action}d successfully.`, { type: 'success', confirmText: 'OK' });
                    closeDetailsModal();
                    fetchAndRenderAllData();
                }
            };
            showConfirmationModal(`Confirm ${action.charAt(0).toUpperCase() + action.slice(1)}`, `Are you sure you want to ${action} this request?`, { type: action === 'deny' ? 'danger' : 'success', confirmText: `Yes, ${action}`, onConfirm: performAction });
        };
    
        const openAddRequestModal = () => {
            addRequestForm.reset();
            returnTimeInput.setCustomValidity('');
            addRequestModal.style.display = 'flex';
        };
    
        const closeAddRequestModal = () => { addRequestModal.style.display = 'none'; };
    
        const handleSaveRequest = async (e) => {
            e.preventDefault();
            if (!addRequestForm.checkValidity() || !returnTimeInput.checkValidity()) {
                addRequestForm.reportValidity();
                return;
            }
            saveRequestBtn.disabled = true;
            saveRequestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            try {
                const formData = new FormData(addRequestForm);
                const departure = new Date(formData.get('departure_time')).toISOString();
                const ret = new Date(formData.get('return_time')).toISOString();
                const requestData = {
                    purpose: formData.get('purpose'),
                    from_location: formData.get('from_location'),
                    to_location: formData.get('to_location'),
                    departure_time: departure,
                    return_time: ret,
                };
                const result = await apiRequest('requests/', 'POST', requestData);
                if (result) {
                    showConfirmationModal('Success', 'Vehicle request created successfully!', { type: 'success', confirmText: 'OK' });
                    closeAddRequestModal();
                    fetchAndRenderAllData();
                }
            } finally {
                saveRequestBtn.disabled = false;
                saveRequestBtn.innerHTML = '<i class="fas fa-save"></i> Save Request';
            }
        };

        const validateReturnTime = () => {
            if (departureTimeInput.value && returnTimeInput.value) {
                const departure = new Date(departureTimeInput.value);
                const ret = new Date(returnTimeInput.value);
                if (ret <= departure) {
                    returnTimeInput.setCustomValidity('Return time must be after the departure time.');
                } else {
                    returnTimeInput.setCustomValidity('');
                }
            }
        };
    
        const handleSearch = (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredRequests = allRequests.filter(req => {
                const requesterName = `${req.requester?.first_name} ${req.requester?.last_name}`.toLowerCase();
                return (
                    requesterName.includes(searchTerm) ||
                    (req.purpose || '').toLowerCase().includes(searchTerm) ||
                    `req-${String(req.id).padStart(4, '0')}`.includes(searchTerm)
                );
            });
            currentPage = 1;
            updatePage();
        };
    
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderAllData();
            document.getElementById('refreshBtn').addEventListener('click', fetchAndRenderAllData);
            searchInput.addEventListener('input', handleSearch);
            requestTableBody.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                if (target.classList.contains('btn-view')) {
                    showRequestDetails(id);
                } else if (target.classList.contains('btn-delete')) {
                    const performDelete = async () => {
                        const result = await apiRequest(`requests/${id}`, 'DELETE');
                        if (result?.success) {
                           showConfirmationModal('Deleted!', 'The request has been successfully deleted.', { type: 'success', confirmText: 'OK' });
                           fetchAndRenderAllData();
                        }
                    };
                    showConfirmationModal('Confirm Deletion', `Are you sure you want to permanently delete request REQ-${String(id).padStart(4, '0')}?`, { type: 'danger', confirmText: 'Yes, Delete', onConfirm: performDelete });
                }
            });
            addRequestBtn.addEventListener('click', openAddRequestModal);
            closeAddModalBtn.addEventListener('click', closeAddRequestModal);
            cancelAddModalBtn.addEventListener('click', closeAddRequestModal);
            addRequestForm.addEventListener('submit', handleSaveRequest);
            closeDetailsModalBtn.addEventListener('click', closeDetailsModal);
            cancelDetailsModalBtn.addEventListener('click', closeDetailsModal);
            updateRequestBtn.addEventListener('click', handleUpdateRequest);
            approveRequestBtn.addEventListener('click', () => handleApprovalAction('approved'));
            denyRequestBtn.addEventListener('click', () => handleApprovalAction('denied'));
            confirmBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') { confirmCallback(); } hideConfirmationModal(); });
            cancelBtn.addEventListener('click', hideConfirmationModal);
            departureTimeInput.addEventListener('change', validateReturnTime);
            returnTimeInput.addEventListener('change', validateReturnTime);
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                 showConfirmationModal('Confirm Logout', 'Are you sure you want to logout?', { type: 'warning', confirmText: 'Logout', onConfirm: () => { localStorage.clear(); window.location.href = '/login.html'; } });
            });
        });
    </script>
</body>
</html>