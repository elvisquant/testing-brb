name: "X. ğŸ’£ Destroy Infrastructure"

# This workflow can only be triggered manually from the GitHub Actions tab.
# This is a safety measure to prevent accidental deletion.
on:
  workflow_dispatch:

jobs:
  destroy:
    runs-on: ubuntu-latest
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Configure AWS"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: "ğŸ—ï¸ Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "âœ… Init Terraform"
      # Initializes Terraform in the correct directory to read your state file from S3
      run: cd infrastructure && terraform init -input=false

    - name: "ğŸ’£ Destroy Infrastructure"
      # Runs the destroy command, automatically approving the action.
      # It passes all the necessary variables to ensure it can correctly interpret the state file.
      run: |
        cd infrastructure && terraform destroy -auto-approve \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"