name: "2. ðŸ—ï¸ Infrastructure"

on:
  workflow_run:
    workflows: ["1. ðŸ” Initial Setup"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: "ðŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ðŸ” Configure AWS"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: "ðŸ—ï¸ Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "ðŸª£ Ensure S3 Bucket"
      run: |
        aws s3 mb s3://brb-app-tf-state-2024 --region us-east-1 || echo "Bucket exists"
        aws s3api put-bucket-versioning --bucket brb-app-tf-state-2024 --versioning-configuration Status=Enabled

    - name: "ðŸ”’ Ensure DynamoDB Table"
      run: |
        aws dynamodb describe-table --table-name brb-app-tf-locks 2>/dev/null || \
        aws dynamodb create-table --table-name brb-app-tf-locks \
          --attribute-definitions AttributeName=LockID,AttributeType=S \
          --key-schema AttributeName=LockID,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST

    - name: "âœ… Init Terraform"
      run: cd infrastructure && terraform init -input=false

    - name: "ðŸš€ Apply Infrastructure"
      run: |
        cd infrastructure && terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ðŸ’¾ Save EC2 IP"
      run: |
        cd infrastructure
        EC2_IP=$(terraform output -raw ec2_public_ip)
        echo "EC2_IP=$EC2_IP"
        # Save to environment for next workflow
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV

    - name: "ðŸ“‹ Infrastructure Complete"
      run: echo "âœ… Infrastructure deployed - EC2 ready at ${{ env.EC2_IP }}"