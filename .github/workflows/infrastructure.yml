name: "2. ğŸ—ï¸ Infrastructure Deployment"

on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
      - 'docker-compose.prod.yml'
  workflow_dispatch:
  workflow_run:
    workflows: ["1. ğŸ” Initial Setup & Secrets Generation"]
    types: [completed]

env:
  AWS_REGION: 'us-east-1'

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      all_secrets_exist: ${{ steps.check.outputs.all_exist }}
      missing_secrets: ${{ steps.check.outputs.missing }}
    
    steps:
    - name: "ğŸ” Check Required Secrets"
      id: check
      env:
        REQUIRED_SECRETS: '["DOCKER_USERNAME", "DOCKER_PASSWORD", "AWS_ACCESS_KEY_ID", "AWS_SECRET_ACCESS_KEY", "DB_PASSWORD", "SECRET_KEY", "EC2_SSH_PUBLIC_KEY"]'
      run: |
        echo "Checking required secrets..."
        
        # Convert JSON string to array
        secrets_array=$(echo '${{ env.REQUIRED_SECRETS }}' | jq -r '.[]')
        missing=""
        all_exist="true"
        
        for secret in $secrets_array; do
          secret_value="${{ secrets[secret] }}"
          if [ -z "$secret_value" ] || [ "$secret_value" = "null" ]; then
            echo "âŒ Missing: $secret"
            missing="$missing $secret"
            all_exist="false"
          else
            echo "âœ… Found: $secret"
          fi
        done
        
        echo "all_exist=$all_exist" >> $GITHUB_OUTPUT
        echo "missing_secrets=$missing" >> $GITHUB_OUTPUT
        
        if [ "$all_exist" = "true" ]; then
          echo "âœ… All required secrets are available"
        else
          echo "âŒ Missing secrets: $missing"
        fi

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.all_secrets_exist == 'true'
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Configure AWS credentials"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: "ğŸ—ï¸ Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "âœ… Initialize Terraform"
      run: |
        cd infrastructure
        terraform init -input=false

    - name: "ğŸ“Š Plan Infrastructure Changes"
      run: |
        cd infrastructure
        terraform plan -no-color -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸš€ Apply Infrastructure Changes"
      run: |
        cd infrastructure
        terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸ’¾ Save EC2 IP Address"
      id: save_outputs
      run: |
        cd infrastructure
        EC2_IP=$(terraform output -raw ec2_public_ip)
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
        echo "EC2_HOST=$EC2_IP" >> $GITHUB_ENV
        echo "âœ… EC2 IP: $EC2_IP"

    - name: "ğŸ“¡ Wait for EC2 Readiness"
      run: |
        echo "â³ Waiting for EC2 instance to be ready..."
        timeout 300 bash -c '
          until nc -z ${{ env.EC2_IP }} 22; do
            echo "Waiting for SSH access...";
            sleep 10;
          done
        ' && echo "âœ… EC2 is ready for SSH" || echo "âš ï¸  EC2 SSH timeout"

  prerequisites-not-met:
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.all_secrets_exist == 'false'
    
    steps:
    - name: "âŒ Prerequisites Not Met"
      run: |
        echo "âŒ Cannot deploy infrastructure - missing secrets:"
        echo "${{ needs.check-secrets.outputs.missing_secrets }}"
        echo ""
        echo "ğŸ“‹ Please ensure all required secrets are set in GitHub:"
        echo "   - DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME && 'âœ…' || 'âŒ' }}"
        echo "   - DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD && 'âœ…' || 'âŒ' }}"
        echo "   - AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID && 'âœ…' || 'âŒ' }}"
        echo "   - AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY && 'âœ…' || 'âŒ' }}"
        echo "   - DB_PASSWORD: ${{ secrets.DB_PASSWORD && 'âœ…' || 'âŒ' }}"
        echo "   - SECRET_KEY: ${{ secrets.SECRET_KEY && 'âœ…' || 'âŒ' }}"
        echo "   - EC2_SSH_PUBLIC_KEY: ${{ secrets.EC2_SSH_PUBLIC_KEY && 'âœ…' || 'âŒ' }}"
        echo ""
        echo "ğŸ’¡ The initial setup workflow should generate most secrets automatically."
        echo "ğŸ”— Check workflow: https://github.com/${{ github.repository }}/actions/workflows/1-initial-setup.yml"