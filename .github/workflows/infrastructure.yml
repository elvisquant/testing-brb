name: "2. ğŸ—ï¸ Infrastructure Deployment"

on:
  workflow_run:
    workflows: ["1. ğŸ” Initial Setup & Secrets Generation"]
    types: [completed]
    branches: [main]

env:
  AWS_REGION: 'us-east-1'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Configure AWS credentials"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: "ğŸ—ï¸ Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "ğŸª£ Create S3 Bucket if not exists"
      run: |
        # Check if bucket exists, create if it doesn't
        if ! aws s3 ls "s3://brb-app-tf-state-2024" 2>/dev/null; then
          echo "ğŸ“¦ Creating S3 bucket for Terraform state..."
          aws s3 mb s3://brb-app-tf-state-2024 --region ${{ env.AWS_REGION }}
          aws s3api put-bucket-versioning \
            --bucket brb-app-tf-state-2024 \
            --versioning-configuration Status=Enabled
          echo "âœ… S3 bucket created"
        else
          echo "âœ… S3 bucket already exists"
        fi

    - name: "ğŸ”’ Create DynamoDB Table if not exists"
      run: |
        # Check if table exists, create if it doesn't
        if ! aws dynamodb describe-table --table-name brb-app-tf-locks 2>/dev/null; then
          echo "ğŸ” Creating DynamoDB table for state locking..."
          aws dynamodb create-table \
            --table-name brb-app-tf-locks \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST
          echo "âœ… DynamoDB table created"
        else
          echo "âœ… DynamoDB table already exists"
        fi

    - name: "â³ Wait for resources to be ready"
      run: |
        echo "â³ Waiting for S3 and DynamoDB to be fully ready..."
        sleep 30

    - name: "âœ… Initialize Terraform"
      run: |
        cd infrastructure
        terraform init -input=false

    - name: "ğŸ“Š Plan Infrastructure"
      run: |
        cd infrastructure
        terraform plan -no-color -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸš€ Apply Infrastructure"
      run: |
        cd infrastructure
        terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸ’¾ Get EC2 IP"
      id: get-ip
      run: |
        cd infrastructure
        EC2_IP=$(terraform output -raw ec2_public_ip)
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
        echo "EC2_HOST=$EC2_IP" >> $GITHUB_ENV

    - name: "ğŸ“¤ Save EC2 IP to GitHub Secrets"
      uses: actions/github-script@v7
      env:
        EC2_IP: ${{ env.EC2_IP }}
      with:
        script: |
          const ec2Ip = process.env.EC2_IP;
          if (ec2Ip && ec2Ip !== 'null') {
            try {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: 'EC2_IP',
                encrypted_value: ec2Ip
              });
              console.log(`âœ… EC2_IP saved: ${ec2Ip}`);
            } catch (error) {
              console.log('âŒ Failed to save EC2_IP:', error.message);
            }
          } else {
            console.log('âŒ No EC2 IP found in Terraform outputs');
          }

    - name: "ğŸ“‹ Infrastructure Complete"
      run: |
        echo "ğŸ¯ INFRASTRUCTURE DEPLOYMENT COMPLETE"
        echo "===================================="
        echo "âœ… S3 bucket ready for Terraform state"
        echo "âœ… DynamoDB table ready for state locking"
        echo "âœ… EC2 instance created"
        echo "âœ… Route53 record configured"
        echo "ğŸŒ Application URL: https://brb.elvisquant.com"
        echo "ğŸš€ Application deployment will now start..."