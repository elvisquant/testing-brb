name: "2. ğŸ—ï¸ Infrastructure"

on:
  workflow_run:
    workflows: ["1. ğŸ” Initial Setup"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Configure AWS"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: "ğŸ—ï¸ Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "âœ… Init Terraform"
      run: cd infrastructure && terraform init -input=false

    - name: "ğŸš€ Apply Infrastructure"
      run: |
        cd infrastructure && terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    # --- THIS IS THE FIX ---
    - name: "â³ Wait for AWS to Stabilize"
      run: |
        echo "Waiting for 60 seconds to ensure the new EC2 instance is fully registered and stable in AWS..."
        sleep 60
        echo "Wait complete."
    # --- END OF FIX ---

    - name: "ğŸ“‹ Infrastructure Complete"
      run: echo "âœ… Infrastructure deployed and stabilized."