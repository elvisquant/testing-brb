name: "2. üèóÔ∏è Infrastructure"

on:
  workflow_run:
    workflows: ["1. üîê Initial Setup"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: "üì• Checkout code"
      uses: actions/checkout@v4

    - name: "üîê Configure AWS"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: "üèóÔ∏è Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "‚úÖ Init Terraform"
      run: cd infrastructure && terraform init -input=false

    - name: "üîÑ Import Existing Resources"
      run: |
        cd infrastructure
        
        # Import existing S3 bucket
        terraform import aws_s3_bucket.tf_state brb-app-tf-state-2024 || echo "S3 bucket already imported or doesn't exist"
        
        # Import existing DynamoDB table
        terraform import aws_dynamodb_table.tf_locks brb-app-tf-locks || echo "DynamoDB table already imported or doesn't exist"

    - name: "üìä Plan Infrastructure"
      run: |
        cd infrastructure && terraform plan -no-color -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "üöÄ Apply Infrastructure"
      run: |
        cd infrastructure && terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "üíæ Get EC2 IP"
      run: |
        cd infrastructure
        EC2_IP=$(terraform output -raw ec2_public_ip)
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
        echo "‚úÖ EC2 IP: $EC2_IP"

    - name: "üì§ Save EC2 IP to GitHub Secrets"
      uses: actions/github-script@v7
      env:
        EC2_IP: ${{ env.EC2_IP }}
      with:
        script: |
          const ec2Ip = process.env.EC2_IP;
          if (ec2Ip && ec2Ip !== 'null') {
            try {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: 'EC2_IP',
                encrypted_value: ec2Ip
              });
              console.log(`‚úÖ EC2_IP saved: ${ec2Ip}`);
            } catch (error) {
              console.log('‚ùå Failed to save EC2_IP:', error.message);
            }
          } else {
            console.log('‚ùå No EC2 IP found');
          }

    - name: "üìã Infrastructure Complete"
      run: echo "‚úÖ Infrastructure deployed - EC2 ready at ${{ env.EC2_IP }}"