name: "2. ğŸ—ï¸ Infrastructure Deployment"

on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
      - 'docker-compose.prod.yml'
  workflow_dispatch:

env:
  AWS_REGION: 'us-east-1'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Configure AWS credentials"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: "ğŸ—ï¸ Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "âœ… Initialize Terraform"
      run: |
        cd infrastructure
        terraform init -input=false

    - name: "ğŸ“Š Plan Infrastructure Changes"
      run: |
        cd infrastructure
        terraform plan -no-color -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸš€ Apply Infrastructure Changes"
      run: |
        cd infrastructure
        terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸ’¾ Save EC2 IP to GitHub Secrets"
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          
          try {
            // Get EC2 IP from Terraform output
            const ec2Ip = execSync('cd infrastructure && terraform output -raw ec2_public_ip', { encoding: 'utf8' }).trim();
            
            if (ec2Ip && ec2Ip !== 'null') {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: 'EC2_IP',
                encrypted_value: ec2Ip
              });
              console.log(`âœ… EC2_IP saved: ${ec2Ip}`);
            } else {
              console.log('âŒ No EC2 IP found in Terraform outputs');
            }
          } catch (error) {
            console.log('âŒ Failed to get/save EC2 IP:', error.message);
          }

    - name: "ğŸ“¡ Wait for EC2 Readiness"
      run: |
        echo "â³ Waiting for EC2 instance to be ready..."
        # This will be handled in the deployment step

    - name: "ğŸ“‹ Infrastructure Status"
      run: |
        echo "ğŸ‰ INFRASTRUCTURE DEPLOYMENT COMPLETE!"
        echo "======================================"
        echo "âœ… EC2 instance created and configured"
        echo "âœ… Route53 record created: brb.elvisquant.com"
        echo "âœ… Security groups configured"
        echo ""
        echo "ğŸŒ Your application will be available at: https://brb.elvisquant.com"
        echo "ğŸ“ Application deployment will run automatically"