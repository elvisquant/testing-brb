name: "2. ğŸ—ï¸ Infrastructure Deployment"

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["1. ğŸ” Initial Setup & Secrets Generation"]
    types: [completed]

env:
  AWS_REGION: 'us-east-1'

jobs:
  check-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      infrastructure_ready: ${{ steps.check.outputs.ready }}
      ec2_ip: ${{ steps.check.outputs.ec2_ip }}
    
    steps:
    - name: "ğŸ” Check if infrastructure exists"
      id: check
      run: |
        # Check if EC2_IP secret exists and has value
        if [ -n "${{ secrets.EC2_IP }}" ] && [ "${{ secrets.EC2_IP }}" != "null" ]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "ec2_ip=${{ secrets.EC2_IP }}" >> $GITHUB_OUTPUT
          echo "âœ… Infrastructure already exists - EC2 IP: ${{ secrets.EC2_IP }}"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "ec2_ip=" >> $GITHUB_OUTPUT
          echo "ğŸ—ï¸ Infrastructure needs to be created"
        fi

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: check-infrastructure
    if: needs.check-infrastructure.outputs.infrastructure_ready == 'false'
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Configure AWS credentials"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: "ğŸ—ï¸ Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "âœ… Initialize Terraform"
      run: |
        cd infrastructure
        terraform init -input=false

    - name: "ğŸ“Š Plan Infrastructure"
      run: |
        cd infrastructure
        terraform plan -no-color -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸš€ Apply Infrastructure"
      run: |
        cd infrastructure
        terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "ğŸ’¾ Save EC2 IP"
      id: save-ip
      run: |
        cd infrastructure
        EC2_IP=$(terraform output -raw ec2_public_ip)
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
        echo "EC2_HOST=$EC2_IP" >> $GITHUB_ENV

    - name: "ğŸ“¤ Update EC2 IP Secret"
      uses: actions/github-script@v7
      env:
        EC2_IP: ${{ env.EC2_IP }}
      with:
        script: |
          const ec2Ip = process.env.EC2_IP;
          if (ec2Ip && ec2Ip !== 'null') {
            try {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: 'EC2_IP',
                encrypted_value: ec2Ip
              });
              console.log(`âœ… EC2_IP saved: ${ec2Ip}`);
            } catch (error) {
              console.log('âŒ Failed to save EC2_IP:', error.message);
            }
          }

  infrastructure-complete:
    runs-on: ubuntu-latest
    needs: [check-infrastructure, deploy-infrastructure]
    steps:
    - name: "ğŸ“‹ Infrastructure Status"
      run: |
        echo "ğŸ¯ INFRASTRUCTURE PHASE COMPLETE"
        echo "================================"
        echo "âœ… Infrastructure check: ${{ needs.check-infrastructure.result }}"
        echo "âœ… Infrastructure deployment: ${{ needs.deploy-infrastructure.result || 'skipped' }}"
        echo "ğŸŒ EC2 IP: ${{ needs.check-infrastructure.outputs.ec2_ip || needs.deploy-infrastructure.outputs.ec2_ip }}"
        echo "ğŸš€ Proceeding to application deployment..."