name: "2. üèóÔ∏è Infrastructure Deployment"

on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
      - 'docker-compose.prod.yml'
  workflow_dispatch:  # Allow manual trigger
  workflow_run:
    workflows: ["1. üîê Initial Setup & Secrets Generation"]
    types: [completed]

env:
  AWS_REGION: 'us-east-1'

jobs:
  check-prerequisites:
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
      missing_secrets: ${{ steps.check.outputs.missing }}
    
    steps:
    - name: "üîç Check Required Secrets"
      id: check
      run: |
        REQUIRED_SECRETS=(
          "DOCKER_USERNAME"
          "DOCKER_PASSWORD"
          "AWS_ACCESS_KEY_ID" 
          "AWS_SECRET_ACCESS_KEY"
          "DB_PASSWORD"
          "SECRET_KEY"
          "EC2_SSH_PUBLIC_KEY"
        )
        
        missing=""
        for secret in "${REQUIRED_SECRETS[@]}"; do
          if [ -z "${{ secrets[secret] }}" ]; then
            missing="$missing $secret"
          fi
        done
        
        if [ -z "$missing" ]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "missing_secrets=" >> $GITHUB_OUTPUT
          echo "‚úÖ All required secrets are available"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "missing_secrets=$missing" >> $GITHUB_OUTPUT
          echo "‚ùå Missing secrets: $missing"
        fi

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.ready == 'true'
    
    steps:
    - name: "üì• Checkout code"
      uses: actions/checkout@v4

    - name: "üîê Configure AWS credentials"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: "üèóÔ∏è Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "‚úÖ Initialize Terraform"
      run: |
        cd infrastructure
        terraform init -input=false

    - name: "üìä Plan Infrastructure Changes"
      run: |
        cd infrastructure
        terraform plan -no-color -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "üöÄ Apply Infrastructure Changes"
      run: |
        cd infrastructure
        terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "üíæ Save EC2 IP Address"
      id: save_outputs
      run: |
        cd infrastructure
        EC2_IP=$(terraform output -raw ec2_public_ip)
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
        echo "EC2_HOST=$EC2_IP" >> $GITHUB_ENV
        echo "‚úÖ EC2 IP: $EC2_IP"

    - name: "üì° Wait for EC2 Readiness"
      run: |
        echo "‚è≥ Waiting for EC2 instance to be ready..."
        timeout 300 bash -c '
          until nc -z ${{ env.EC2_IP }} 22; do
            echo "Waiting for SSH access...";
            sleep 10;
          done
        ' && echo "‚úÖ EC2 is ready for SSH" || echo "‚ö†Ô∏è  EC2 SSH timeout"

  prerequisites-not-met:
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.ready == 'false'
    
    steps:
    - name: "‚ùå Prerequisites Not Met"
      run: |
        echo "‚ùå Cannot deploy infrastructure - missing secrets:"
        echo "${{ needs.check-prerequisites.outputs.missing_secrets }}"
        echo ""
        echo "üìã Please ensure all required secrets are set in GitHub:"
        echo "   - DOCKER_USERNAME"
        echo "   - DOCKER_PASSWORD"
        echo "   - AWS_ACCESS_KEY_ID"
        echo "   - AWS_SECRET_ACCESS_KEY"
        echo "   - DB_PASSWORD" 
        echo "   - SECRET_KEY"
        echo "   - EC2_SSH_PUBLIC_KEY"
        echo ""
        echo "üí° The initial setup workflow should generate most secrets automatically."