name: "2. üèóÔ∏è Infrastructure Deployment"

on:
  workflow_dispatch:  # Manual trigger only

env:
  AWS_REGION: 'us-east-1'

jobs:
  check-required-secrets:
    runs-on: ubuntu-latest
    outputs:
      all_secrets_exist: ${{ steps.check.outputs.all_exist }}
    steps:
    - name: "üîç Check Required Secrets"
      id: check
      run: |
        echo "Checking required secrets..."
        
        # Check each secret individually
        if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
          echo "‚ùå Missing: DB_PASSWORD"
          echo "all_exist=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.SECRET_KEY }}" ]; then
          echo "‚ùå Missing: SECRET_KEY"
          echo "all_exist=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.EC2_SSH_PUBLIC_KEY }}" ]; then
          echo "‚ùå Missing: EC2_SSH_PUBLIC_KEY"
          echo "all_exist=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "‚ùå Missing: DOCKER_USERNAME"
          echo "all_exist=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "‚ùå Missing: DOCKER_PASSWORD"
          echo "all_exist=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "‚ùå Missing: AWS_ACCESS_KEY_ID"
          echo "all_exist=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "‚ùå Missing: AWS_SECRET_ACCESS_KEY"
          echo "all_exist=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "‚úÖ All required secrets exist"
        echo "all_exist=true" >> $GITHUB_OUTPUT

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: check-required-secrets
    if: needs.check-required-secrets.outputs.all_secrets_exist == 'true'
    
    steps:
    - name: "üì• Checkout code"
      uses: actions/checkout@v4

    - name: "üîê Configure AWS credentials"
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: "üèóÔ∏è Setup Terraform"
      uses: hashicorp/setup-terraform@v3

    - name: "ü™£ Create S3 Bucket if not exists"
      run: |
        # Check if bucket exists, create if it doesn't
        if ! aws s3 ls "s3://brb-app-tf-state-2024" 2>/dev/null; then
          echo "üì¶ Creating S3 bucket for Terraform state..."
          aws s3 mb s3://brb-app-tf-state-2024 --region ${{ env.AWS_REGION }}
          aws s3api put-bucket-versioning \
            --bucket brb-app-tf-state-2024 \
            --versioning-configuration Status=Enabled
          echo "‚úÖ S3 bucket created"
        else
          echo "‚úÖ S3 bucket already exists"
        fi

    - name: "üîí Create DynamoDB Table if not exists"
      run: |
        # Check if table exists, create if it doesn't
        if ! aws dynamodb describe-table --table-name brb-app-tf-locks 2>/dev/null; then
          echo "üîê Creating DynamoDB table for state locking..."
          aws dynamodb create-table \
            --table-name brb-app-tf-locks \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST
          echo "‚úÖ DynamoDB table created"
        else
          echo "‚úÖ DynamoDB table already exists"
        fi

    - name: "‚è≥ Wait for resources to be ready"
      run: |
        echo "‚è≥ Waiting for S3 and DynamoDB to be fully ready..."
        sleep 30

    - name: "‚úÖ Initialize Terraform"
      run: |
        cd infrastructure
        terraform init -input=false

    - name: "üìä Plan Infrastructure"
      run: |
        cd infrastructure
        terraform plan -no-color -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "üöÄ Apply Infrastructure"
      run: |
        cd infrastructure
        terraform apply -auto-approve -input=false \
          -var="docker_username=${{ secrets.DOCKER_USERNAME }}" \
          -var="docker_password=${{ secrets.DOCKER_PASSWORD }}" \
          -var="db_password=${{ secrets.DB_PASSWORD }}" \
          -var="secret_key=${{ secrets.SECRET_KEY }}" \
          -var="ssh_public_key=${{ secrets.EC2_SSH_PUBLIC_KEY }}"

    - name: "üíæ Get EC2 IP"
      id: get-ip
      run: |
        cd infrastructure
        EC2_IP=$(terraform output -raw ec2_public_ip)
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
        echo "EC2_HOST=$EC2_IP" >> $GITHUB_ENV

    - name: "üì§ Save EC2 IP to GitHub Secrets"
      uses: actions/github-script@v7
      env:
        EC2_IP: ${{ env.EC2_IP }}
      with:
        script: |
          const ec2Ip = process.env.EC2_IP;
          if (ec2Ip && ec2Ip !== 'null') {
            try {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: 'EC2_IP',
                encrypted_value: ec2Ip
              });
              console.log(`‚úÖ EC2_IP saved: ${ec2Ip}`);
            } catch (error) {
              console.log('‚ùå Failed to save EC2_IP:', error.message);
            }
          } else {
            console.log('‚ùå No EC2 IP found in Terraform outputs');
          }

    - name: "üöÄ Trigger Deployment Workflow"
      uses: actions/github-script@v7
      with:
        script: |
          try {
            // Trigger the deployment workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '3-deploy.yml',
              ref: 'main'
            });
            console.log('‚úÖ Triggered application deployment workflow');
          } catch (error) {
            console.log('‚ùå Failed to trigger deployment workflow:', error.message);
          }

  secrets-missing:
    runs-on: ubuntu-latest
    needs: check-required-secrets
    if: needs.check-required-secrets.outputs.all_secrets_exist == 'false'
    
    steps:
    - name: "‚ùå Secrets Missing"
      run: |
        echo "‚ùå CANNOT DEPLOY INFRASTRUCTURE"
        echo "=============================="
        echo "Required secrets are missing."
        echo ""
        echo "Please ensure these secrets are set in GitHub:"
        echo "- DB_PASSWORD"
        echo "- SECRET_KEY"
        echo "- EC2_SSH_PUBLIC_KEY"
        echo "- DOCKER_USERNAME"
        echo "- DOCKER_PASSWORD"
        echo "- AWS_ACCESS_KEY_ID"
        echo "- AWS_SECRET_ACCESS_KEY"
        echo ""
        echo "Run the '1. üîê Initial Setup & Secrets Generation' workflow first to generate some secrets automatically."