name: üîê Generate Required Secrets

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/generate-secrets.yml'
  workflow_dispatch:  # Manual trigger
  repository_dispatch: # API trigger

jobs:
  generate-secrets:
    runs-on: ubuntu-latest
    if: ${{ !contains(secrets.INITIALIZED, 'true') }}  # Only run if not initialized
    
    steps:
    - name: üîç Check if Secrets Already Exist
      id: check_secrets
      run: |
        if [ -n "${{ secrets.DB_PASSWORD }}" ] && \
           [ -n "${{ secrets.SECRET_KEY }}" ] && \
           [ -n "${{ secrets.EC2_SSH_KEY }}" ] && \
           [ -n "${{ secrets.EC2_SSH_PUBLIC_KEY }}" ]; then
          echo "secrets_exist=true" >> $GITHUB_OUTPUT
          echo "‚úÖ All secrets already exist"
        else
          echo "secrets_exist=false" >> $GITHUB_OUTPUT
          echo "üîê Some secrets are missing, generating..."
        fi

    - name: üîß Generate Secrets
      if: steps.check_secrets.outputs.secrets_exist == 'false'
      run: |
        # Generate DB Password (24 characters)
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD" >> secrets.env
        
        # Generate Secret Key (48 characters)
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY" >> secrets.env
        
        # Generate SSH Key Pair
        ssh-keygen -t rsa -b 4096 -C "brb-app-ec2" -f brb-key -N "" -q
        
        # Read the generated keys
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY" >> secrets.env
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY" >> secrets.env
        
        # Create a marker that we've generated secrets
        echo "INITIALIZED=true" >> secrets.env
        
        echo "‚úÖ All secrets generated successfully!"
        echo "üîë Public Key: $EC2_SSH_PUBLIC_KEY"

    - name: üì§ Update GitHub Secrets
      if: steps.check_secrets.outputs.secrets_exist == 'false'
      uses: actions/github-script@v7
      env:
        SECRETS_FILE: secrets.env
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          // Read generated secrets
          const secretsContent = fs.readFileSync('${{ env.SECRETS_FILE }}', 'utf8');
          const secrets = {};
          
          secretsContent.split('\n').forEach(line => {
            const [key, value] = line.split('=');
            if (key && value) {
              secrets[key] = value;
            }
          });
          
          // Update each secret
          for (const [key, value] of Object.entries(secrets)) {
            try {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: key,
                encrypted_value: value
              });
              console.log(`‚úÖ Updated secret: ${key}`);
            } catch (error) {
              console.log(`‚ùå Failed to update ${key}:`, error.message);
            }
          }
          
          console.log('üéâ All secrets updated successfully!');

    - name: üßπ Cleanup
      if: always()
      run: |
        rm -f secrets.env brb-key brb-key.pub

  verify-secrets:
    runs-on: ubuntu-latest
    needs: generate-secrets
    if: always()
    
    steps:
    - name: ‚úÖ Verify Secrets Are Set
      run: |
        echo "Checking if all required secrets are set..."
        REQUIRED_SECRETS=("DB_PASSWORD" "SECRET_KEY" "EC2_SSH_KEY" "EC2_SSH_PUBLIC_KEY" "DOCKER_USERNAME" "DOCKER_PASSWORD" "AWS_ACCESS_KEY_ID" "AWS_SECRET_ACCESS_KEY")
        
        all_set=true
        for secret in "${REQUIRED_SECRETS[@]}"; do
          if [ -z "${{ secrets[secret] }}" ]; then
            echo "‚ùå Missing: $secret"
            all_set=false
          else
            echo "‚úÖ Found: $secret"
          fi
        done
        
        if [ "$all_set" = true ]; then
          echo "üéâ All secrets are ready! Infrastructure can be deployed."
        else
          echo "‚ùå Some secrets are missing. Please check the workflow."
          exit 1
        fi