name: "1. ðŸ” Initial Setup"

on:
  push:
    branches: [ main ]

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: "ðŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ðŸ” Generate DB_PASSWORD if missing"
      if: ${{ !secrets.DB_PASSWORD }}
      run: |
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD" >> secrets.txt
        echo "âœ… Generated DB_PASSWORD"

    - name: "ðŸ” Generate SECRET_KEY if missing"
      if: ${{ !secrets.SECRET_KEY }}
      run: |
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY" >> secrets.txt
        echo "âœ… Generated SECRET_KEY"

    - name: "ðŸ” Generate SSH keys if missing"
      if: ${{ !secrets.EC2_SSH_PUBLIC_KEY }}
      run: |
        ssh-keygen -t rsa -b 4096 -C "brb-app" -f brb-key -N "" -q
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY" >> secrets.txt
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY" >> secrets.txt
        echo "âœ… Generated SSH keys"

    - name: "ðŸ“¤ Save secrets to GitHub"
      if: hashFiles('secrets.txt') != ''
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('secrets.txt')) {
            const content = fs.readFileSync('secrets.txt', 'utf8');
            const lines = content.split('\n');
            for (const line of lines) {
              const [key, value] = line.split('=');
              if (key && value) {
                await github.rest.actions.createOrUpdateRepoSecret({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  secret_name: key.trim(),
                  encrypted_value: value.trim()
                });
                console.log(`âœ… Saved ${key.trim()}`);
              }
            }
          }

    - name: "ðŸ§¹ Cleanup"
      run: rm -f secrets.txt brb-key brb-key.pub

    - name: "ðŸ“‹ Setup complete"
      run: echo "âœ… Initial setup complete - secrets are ready"