name: "1. ğŸ” Initial Setup & Secrets Generation"

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/1-initial-setup.yml'

env:
  AWS_REGION: 'us-east-1'

jobs:
  generate-secrets:
    runs-on: ubuntu-latest
    # Only run if secrets don't exist yet
    if: ${{ !contains(secrets.INITIALIZED, 'true') }}
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Generate Secure Secrets"
      id: generate_secrets
      run: |
        echo "ğŸ›¡ï¸ Generating secure secrets automatically..."
        
        # Generate strong database password (24 characters)
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9!@#$%' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD" >> secrets.env
        
        # Generate secret key for FastAPI (48 characters)
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY" >> secrets.env
        
        # Generate SSH key pair for EC2 access
        ssh-keygen -t rsa -b 4096 -C "brb-app-ec2@brb.elvisquant.com" -f brb-key -N "" -q
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY" >> secrets.env
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY" >> secrets.env
        
        echo "âœ… All secrets generated successfully!"
        echo "ğŸ”‘ Public Key Fingerprint: $(ssh-keygen -lf brb-key.pub | awk '{print $2}')"

    - name: "ğŸ“¤ Save Secrets to GitHub"
      uses: actions/github-script@v7
      env:
        SECRETS_FILE: secrets.env
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          console.log('ğŸ’¾ Saving secrets to GitHub...');
          
          // Read generated secrets
          const secretsContent = fs.readFileSync('${{ env.SECRETS_FILE }}', 'utf8');
          const secrets = {};
          
          secretsContent.split('\n').forEach(line => {
            const [key, value] = line.split('=');
            if (key && value) {
              secrets[key] = value;
            }
          });
          
          // Save each secret to GitHub
          for (const [key, value] of Object.entries(secrets)) {
            try {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: key,
                encrypted_value: value
              });
              console.log(`âœ… Saved: ${key}`);
            } catch (error) {
              console.log(`âŒ Failed to save ${key}:`, error.message);
            }
          }
          
          // Mark as initialized
          await github.rest.actions.createOrUpdateRepoSecret({
            owner: context.repo.owner,
            repo: context.repo.repo,
            secret_name: 'INITIALIZED',
            encrypted_value: 'true'
          });
          
          console.log('ğŸ‰ All secrets saved! Project is ready for infrastructure deployment.');

    - name: "ğŸ§¹ Cleanup Temporary Files"
      if: always()
      run: |
        rm -f secrets.env brb-key brb-key.pub

  verify-setup:
    runs-on: ubuntu-latest
    needs: generate-secrets
    if: always()
    
    steps:
    - name: "âœ… Verify Setup Completion"
      run: |
        echo "ğŸ“‹ Setup Status:"
        echo "========================"
        echo "ğŸ” Secrets Generation: ${{ needs.generate-secrets.result }}"
        echo ""
        echo "ğŸ“ Next Steps:"
        echo "1. Make sure these MANUAL secrets are set in GitHub:"
        echo "   - DOCKER_USERNAME"
        echo "   - DOCKER_PASSWORD" 
        echo "   - AWS_ACCESS_KEY_ID"
        echo "   - AWS_SECRET_ACCESS_KEY"
        echo ""
        echo "2. Push any change to trigger infrastructure deployment"
        echo "3. Your app will deploy automatically to: https://brb.elvisquant.com"