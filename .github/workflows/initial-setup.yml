name: "1. ğŸ” Initial Setup & Secrets Generation"

on:
  push:
    branches: [ main ]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      secrets_ready: ${{ steps.check.outputs.ready }}
    steps:
    - name: "ğŸ” Check if secrets already exist"
      id: check
      run: |
        # Check if essential secrets exist by trying to use them
        if [ -n "${{ secrets.DB_PASSWORD }}" ] && [ -n "${{ secrets.EC2_SSH_PUBLIC_KEY }}" ]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "âœ… Secrets already exist"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "ğŸ” Secrets need to be generated"
        fi

  generate-secrets:
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets_ready == 'false'
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Generate Secure Secrets"
      run: |
        echo "ğŸ›¡ï¸ Generating secure secrets automatically..."
        
        # Generate strong database password
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD" >> secrets.txt
        
        # Generate secret key for FastAPI
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY" >> secrets.txt
        
        # Generate SSH key pair for EC2 access
        ssh-keygen -t rsa -b 4096 -C "brb-app-ec2" -f brb-key -N "" -q
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY" >> secrets.txt
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY" >> secrets.txt
        
        echo "âœ… All secrets generated successfully!"

    - name: "ğŸ“¤ Save Secrets to GitHub"
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          console.log('ğŸ’¾ Saving secrets to GitHub...');
          
          if (!fs.existsSync('secrets.txt')) {
            console.log('âŒ secrets.txt not found');
            return;
          }
          
          const secretsContent = fs.readFileSync('secrets.txt', 'utf8');
          const lines = secretsContent.split('\n');
          
          for (const line of lines) {
            const [key, value] = line.split('=');
            if (key && value) {
              try {
                await github.rest.actions.createOrUpdateRepoSecret({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  secret_name: key.trim(),
                  encrypted_value: value.trim()
                });
                console.log(`âœ… Saved: ${key.trim()}`);
              } catch (error) {
                console.log(`âš ï¸ Could not save ${key}:`, error.message);
              }
            }
          }

    - name: "ğŸ§¹ Cleanup"
      run: |
        rm -f secrets.txt brb-key brb-key.pub

  setup-complete:
    runs-on: ubuntu-latest
    needs: [check-secrets, generate-secrets]
    steps:
    - name: "ğŸ“‹ Setup Status"
      run: |
        echo "ğŸ¯ SETUP PHASE COMPLETE"
        echo "======================="
        echo "âœ… Secrets check: ${{ needs.check-secrets.result }}"
        echo "âœ… Secrets generation: ${{ needs.generate-secrets.result || 'skipped' }}"
        echo "ğŸš€ Proceeding to infrastructure deployment..."