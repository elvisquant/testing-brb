name: "1. ğŸ” Initial Setup & Secrets Generation"

on:
  push:
    branches: [ main ]

jobs:
  check-and-generate-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Check if secrets exist"
      id: check-secrets
      run: |
        echo "Checking if secrets need to be generated..."
        # Check if essential secrets exist
        if [ -n "${{ secrets.DB_PASSWORD }}" ] && [ -n "${{ secrets.EC2_SSH_PUBLIC_KEY }}" ]; then
          echo "âœ… All secrets already exist"
          echo "skip_generation=true" >> $GITHUB_ENV
        else
          echo "ğŸ” Some secrets are missing, generating..."
          echo "skip_generation=false" >> $GITHUB_ENV
        fi

    - name: "ğŸ” Generate Secrets if Needed"
      if: env.skip_generation == 'false'
      run: |
        echo "ğŸ›¡ï¸ Generating secure secrets automatically..."
        
        # Generate strong database password
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD" >> secrets.txt
        
        # Generate secret key for FastAPI
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY" >> secrets.txt
        
        # Generate SSH key pair for EC2 access
        ssh-keygen -t rsa -b 4096 -C "brb-app-ec2" -f brb-key -N "" -q
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY" >> secrets.txt
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY" >> secrets.txt
        
        echo "âœ… All secrets generated successfully!"
        echo "Secrets generated: DB_PASSWORD, SECRET_KEY, EC2_SSH_PRIVATE_KEY, EC2_SSH_PUBLIC_KEY"

    - name: "ğŸ“¤ Save Generated Secrets"
      if: env.skip_generation == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (!fs.existsSync('secrets.txt')) {
            console.log('âŒ No secrets to save - generation was skipped');
            return;
          }
          
          const secretsContent = fs.readFileSync('secrets.txt', 'utf8');
          const lines = secretsContent.split('\n');
          
          let savedCount = 0;
          for (const line of lines) {
            const [key, value] = line.split('=');
            if (key && value) {
              try {
                await github.rest.actions.createOrUpdateRepoSecret({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  secret_name: key.trim(),
                  encrypted_value: value.trim()
                });
                console.log(`âœ… Saved: ${key.trim()}`);
                savedCount++;
              } catch (error) {
                console.log(`âš ï¸ Could not save ${key}:`, error.message);
              }
            }
          }
          
          console.log(`ğŸ‰ Saved ${savedCount} secrets to GitHub`);

    - name: "ğŸ§¹ Cleanup"
      if: always()
      run: |
        rm -f secrets.txt brb-key brb-key.pub

    - name: "ğŸ“‹ Setup Complete"
      run: |
        echo "ğŸ¯ INITIAL SETUP COMPLETE"
        echo "========================"
        if [ "${{ env.skip_generation }}" == "true" ]; then
          echo "âœ… All secrets already exist - skipping generation"
        else
          echo "âœ… Secrets generated and saved successfully"
        fi
        echo "ğŸš€ Infrastructure deployment will now start..."