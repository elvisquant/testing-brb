name: "1. ğŸ” Initial Setup"

on:
  push:
    branches: [ main ]

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Generate All Secrets"
      run: |
        echo "ğŸ›¡ï¸ Generating all secrets..."
        
        # Always generate secrets (idempotent)
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD" >> secrets.txt
        
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY" >> secrets.txt
        
        ssh-keygen -t rsa -b 4096 -C "brb-app" -f brb-key -N "" -q
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY" >> secrets.txt
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY" >> secrets.txt
        
        echo "âœ… All secrets generated"

    - name: "ğŸ“¤ Save Secrets to GitHub"
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('secrets.txt')) {
            const content = fs.readFileSync('secrets.txt', 'utf8');
            const lines = content.split('\n');
            for (const line of lines) {
              const [key, value] = line.split('=');
              if (key && value) {
                try {
                  await github.rest.actions.createOrUpdateRepoSecret({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    secret_name: key.trim(),
                    encrypted_value: value.trim()
                  });
                  console.log(`âœ… Saved ${key.trim()}`);
                } catch (error) {
                  console.log(`âš ï¸ ${key} may already exist`);
                }
              }
            }
          }

    - name: "ğŸ§¹ Cleanup"
      run: rm -f secrets.txt brb-key brb-key.pub

    - name: "ğŸ“‹ Setup Complete"
      run: echo "âœ… Initial setup complete - secrets are ready"