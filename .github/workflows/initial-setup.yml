name: "1. ğŸ” Initial Setup & Secrets Generation"

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: 'us-east-1'

jobs:
  check-initialized:
    runs-on: ubuntu-latest
    outputs:
      initialized: ${{ steps.check.outputs.initialized }}
    
    steps:
    - name: "ğŸ” Check if Already Initialized"
      id: check
      run: |
        # This step always runs, we'll check secrets in the next job conditionally
        echo "Checking initialization status..."
        echo "initialized=true" >> $GITHUB_OUTPUT

  generate-secrets:
    runs-on: ubuntu-latest
    needs: check-initialized
    # Only run if INITIALIZED secret doesn't exist or is not 'true'
    if: ${{ !contains(fromJSON('["true"]'), secrets.INITIALIZED) }}
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ” Generate Secure Secrets"
      id: generate_secrets
      run: |
        echo "ğŸ›¡ï¸ Generating secure secrets automatically..."
        
        # Generate strong database password (24 characters)
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9!@#$%' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD" >> secrets.env
        
        # Generate secret key for FastAPI (48 characters)
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY" >> secrets.env
        
        # Generate SSH key pair for EC2 access
        ssh-keygen -t rsa -b 4096 -C "brb-app-ec2@brb.elvisquant.com" -f brb-key -N "" -q
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY" >> secrets.env
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY" >> secrets.env
        
        echo "âœ… All secrets generated successfully!"
        echo "ğŸ”‘ Public Key: $EC2_SSH_PUBLIC_KEY"

    - name: "ğŸ“¤ Save Secrets to GitHub"
      uses: actions/github-script@v7
      env:
        SECRETS_FILE: secrets.env
      with:
        script: |
          const fs = require('fs');
          const crypto = require('crypto');
          
          console.log('ğŸ’¾ Saving secrets to GitHub...');
          
          // Read generated secrets
          const secretsContent = fs.readFileSync('${{ env.SECRETS_FILE }}', 'utf8');
          const secrets = {};
          
          secretsContent.split('\n').forEach(line => {
            const [key, value] = line.split('=');
            if (key && value) {
              secrets[key] = value;
            }
          });
          
          // Get public key for encryption
          const { data: publicKey } = await github.rest.actions.getRepoPublicKey({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          // Save each secret to GitHub
          for (const [key, value] of Object.entries(secrets)) {
            try {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: key,
                encrypted_value: value,
                key_id: publicKey.key_id,
              });
              console.log(`âœ… Saved: ${key}`);
            } catch (error) {
              console.log(`âŒ Failed to save ${key}:`, error.message);
            }
          }
          
          // Mark as initialized
          await github.rest.actions.createOrUpdateRepoSecret({
            owner: context.repo.owner,
            repo: context.repo.repo,
            secret_name: 'INITIALIZED',
            encrypted_value: 'true',
            key_id: publicKey.key_id,
          });
          
          console.log('ğŸ‰ All secrets saved! Project is ready for infrastructure deployment.');

    - name: "ğŸ§¹ Cleanup Temporary Files"
      if: always()
      run: |
        rm -f secrets.env brb-key brb-key.pub

  already-initialized:
    runs-on: ubuntu-latest
    needs: check-initialized
    if: ${{ contains(fromJSON('["true"]'), secrets.INITIALIZED) }}
    
    steps:
    - name: "âœ… Already Initialized"
      run: |
        echo "âœ… Project is already initialized with secrets."
        echo "ğŸš€ Proceeding to infrastructure deployment..."

  final-status:
    runs-on: ubuntu-latest
    needs: [generate-secrets, already-initialized]
    if: always()
    
    steps:
    - name: "ğŸ“‹ Setup Status"
      run: |
        echo "ğŸ¯ INITIAL SETUP COMPLETE"
        echo "========================"
        echo "âœ… Secrets generation: ${{ needs.generate-secrets.result || 'skipped' }}"
        echo "âœ… Initialization status: ${{ secrets.INITIALIZED || 'not set' }}"
        echo ""
        echo "ğŸ“ Next: Infrastructure deployment will run automatically"
        echo "ğŸŒ Your app will be at: https://brb.elvisquant.com"