name: "1. üîê Initial Setup & Secrets Generation"

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/1-initial-setup.yml'

jobs:
  generate-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: "üì• Checkout code"
      uses: actions/checkout@v4

    - name: "üîê Generate Secure Secrets"
      id: generate_secrets
      run: |
        echo "üõ°Ô∏è Generating secure secrets automatically..."
        
        # Generate strong database password
        DB_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 24)
        echo "DB_PASSWORD=$DB_PASSWORD"
        
        # Generate secret key for FastAPI
        SECRET_KEY=$(openssl rand -base64 48)
        echo "SECRET_KEY=$SECRET_KEY"
        
        # Generate SSH key pair for EC2 access
        ssh-keygen -t rsa -b 4096 -C "brb-app-ec2" -f brb-key -N "" -q
        EC2_SSH_PRIVATE_KEY=$(cat brb-key | base64 -w 0)
        EC2_SSH_PUBLIC_KEY=$(cat brb-key.pub)
        
        echo "EC2_SSH_PRIVATE_KEY=$EC2_SSH_PRIVATE_KEY"
        echo "EC2_SSH_PUBLIC_KEY=$EC2_SSH_PUBLIC_KEY"
        
        # Save to files for next steps
        echo "$DB_PASSWORD" > db_password.txt
        echo "$SECRET_KEY" > secret_key.txt
        echo "$EC2_SSH_PRIVATE_KEY" > ssh_private_key.txt
        echo "$EC2_SSH_PUBLIC_KEY" > ssh_public_key.txt
        
        echo "‚úÖ All secrets generated successfully!"

    - name: "üì§ Save DB_PASSWORD to GitHub Secrets"
      uses: actions/github-script@v7
      env:
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      with:
        script: |
          const fs = require('fs');
          const dbPassword = fs.readFileSync('db_password.txt', 'utf8').trim();
          
          if (!dbPassword) {
            console.log('‚ùå No DB_PASSWORD generated');
            return;
          }
          
          try {
            await github.rest.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'DB_PASSWORD',
              encrypted_value: dbPassword
            });
            console.log('‚úÖ DB_PASSWORD saved successfully');
          } catch (error) {
            console.log('‚ùå Failed to save DB_PASSWORD:', error.message);
          }

    - name: "üì§ Save SECRET_KEY to GitHub Secrets"
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const secretKey = fs.readFileSync('secret_key.txt', 'utf8').trim();
          
          if (!secretKey) {
            console.log('‚ùå No SECRET_KEY generated');
            return;
          }
          
          try {
            await github.rest.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'SECRET_KEY',
              encrypted_value: secretKey
            });
            console.log('‚úÖ SECRET_KEY saved successfully');
          } catch (error) {
            console.log('‚ùå Failed to save SECRET_KEY:', error.message);
          }

    - name: "üì§ Save EC2_SSH_PRIVATE_KEY to GitHub Secrets"
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const sshPrivateKey = fs.readFileSync('ssh_private_key.txt', 'utf8').trim();
          
          if (!sshPrivateKey) {
            console.log('‚ùå No EC2_SSH_PRIVATE_KEY generated');
            return;
          }
          
          try {
            await github.rest.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'EC2_SSH_PRIVATE_KEY',
              encrypted_value: sshPrivateKey
            });
            console.log('‚úÖ EC2_SSH_PRIVATE_KEY saved successfully');
          } catch (error) {
            console.log('‚ùå Failed to save EC2_SSH_PRIVATE_KEY:', error.message);
          }

    - name: "üì§ Save EC2_SSH_PUBLIC_KEY to GitHub Secrets"
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const sshPublicKey = fs.readFileSync('ssh_public_key.txt', 'utf8').trim();
          
          if (!sshPublicKey) {
            console.log('‚ùå No EC2_SSH_PUBLIC_KEY generated');
            return;
          }
          
          try {
            await github.rest.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'EC2_SSH_PUBLIC_KEY',
              encrypted_value: sshPublicKey
            });
            console.log('‚úÖ EC2_SSH_PUBLIC_KEY saved successfully');
          } catch (error) {
            console.log('‚ùå Failed to save EC2_SSH_PUBLIC_KEY:', error.message);
          }

    - name: "üì§ Mark as INITIALIZED"
      uses: actions/github-script@v7
      with:
        script: |
          try {
            await github.rest.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'INITIALIZED',
              encrypted_value: 'true'
            });
            console.log('‚úÖ INITIALIZED flag set to true');
          } catch (error) {
            console.log('‚ùå Failed to set INITIALIZED:', error.message);
          }

    - name: "üßπ Cleanup Temporary Files"
      if: always()
      run: |
        rm -f db_password.txt secret_key.txt ssh_private_key.txt ssh_public_key.txt brb-key brb-key.pub

    - name: "üìã Setup Complete"
      run: |
        echo "üéâ INITIAL SETUP COMPLETE!"
        echo "=========================="
        echo "‚úÖ All secrets have been generated and saved"
        echo ""
        echo "üìù NEXT STEPS:"
        echo "1. Go to Repository Settings ‚Üí Secrets ‚Üí Actions"
        echo "2. Verify these secrets exist:"
        echo "   - DB_PASSWORD"
        echo "   - SECRET_KEY" 
        echo "   - EC2_SSH_PRIVATE_KEY"
        echo "   - EC2_SSH_PUBLIC_KEY"
        echo "   - INITIALIZED"
        echo ""
        echo "3. Make sure these MANUAL secrets are also set:"
        echo "   - DOCKER_USERNAME"
        echo "   - DOCKER_PASSWORD"
        echo "   - AWS_ACCESS_KEY_ID"
        echo "   - AWS_SECRET_ACCESS_KEY"
        echo ""
        echo "4. Push any change to trigger infrastructure deployment"