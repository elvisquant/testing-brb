name: "3. ğŸš€ Application Deployment"

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'infrastructure/**'
      - '.github/workflows/1-initial-setup.yml'
      - '.github/workflows/2-infrastructure.yml'
  workflow_run:
    workflows: ["2. ğŸ—ï¸ Infrastructure Deployment"]
    types: [completed]

env:
  DOCKER_REGISTRY: docker.io
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/brb-app-backend

jobs:
  check-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      infrastructure_ready: ${{ steps.check.outputs.ready }}
      ec2_host: ${{ steps.check.outputs.ec2_host }}
    
    steps:
    - name: "ğŸ” Check Infrastructure Status"
      id: check
      run: |
        # Check if we have an EC2 IP from infrastructure deployment
        EC2_IP="${{ secrets.EC2_IP }}"
        if [ -n "$EC2_IP" ] && [ "$EC2_IP" != "null" ]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "ec2_host=$EC2_IP" >> $GITHUB_OUTPUT
          echo "âœ… Infrastructure is ready - EC2 IP: $EC2_IP"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "ec2_host=" >> $GITHUB_OUTPUT
          echo "âŒ Infrastructure not ready - EC2_IP secret not set"
        fi

  build-and-push:
    runs-on: ubuntu-latest
    needs: check-infrastructure
    if: needs.check-infrastructure.outputs.infrastructure_ready == 'true'
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ³ Set up Docker Buildx"
      uses: docker/setup-buildx-action@v3

    - name: "ğŸ” Login to Docker Hub"
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: "ğŸ·ï¸ Extract version information"
      id: version
      run: |
        echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "âœ… Version: $(git rev-parse --short HEAD)"

    - name: "ğŸ—ï¸ Build and push Docker image"
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: |
          ${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.version.outputs.IMAGE_TAG }}
          ${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
        build-args: |
          COMMIT_SHA=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-application:
    runs-on: ubuntu-latest
    needs: [check-infrastructure, build-and-push]
    if: needs.check-infrastructure.outputs.infrastructure_ready == 'true'
    
    steps:
    - name: "ğŸš€ Deploy to EC2 Instance"
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ needs.check-infrastructure.outputs.ec2_host }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        script: |
          set -e
          echo "ğŸ¯ Starting application deployment..."
          
          # Wait for Docker to be ready
          until docker info > /dev/null 2>&1; do
            echo "â³ Waiting for Docker to be ready..."
            sleep 10
          done
          
          cd /opt/brb-app
          
          # Update environment with new version
          echo "ğŸ”„ Updating environment with new version..."
          sudo sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=${{ needs.build-and-push.outputs.IMAGE_TAG }}/" .env
          sudo sed -i "s/COMMIT_SHA=.*/COMMIT_SHA=${{ github.sha }}/" .env
          
          # Ensure we have the latest docker-compose file
          echo "ğŸ“¥ Ensuring latest docker-compose file..."
          if [ ! -f docker-compose.prod.yml ]; then
            echo "ğŸ“‹ Downloading docker-compose file..."
            curl -o docker-compose.prod.yml \
              "https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.prod.yml"
          fi
          
          # Pull and deploy new version
          echo "ğŸ³ Pulling new Docker image..."
          sudo docker-compose -f docker-compose.prod.yml pull backend
          
          echo "ğŸ”„ Starting services..."
          sudo docker-compose -f docker-compose.prod.yml up -d
          
          # Wait for health check with retries
          echo "â³ Waiting for application to be healthy..."
          for i in {1..12}; do
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Application health check passed!"
              break
            fi
            echo "Attempt $i/12: Application not ready yet..."
            sleep 10
          done
          
          # Final verification
          if curl -f http://localhost:8000/health; then
            echo "ğŸ‰ Deployment successful!"
            echo "ğŸ“¦ New version: ${{ needs.build-and-push.outputs.IMAGE_TAG }}"
            echo "ğŸŒ Application URL: https://brb.elvisquant.com"
            
            # Cleanup old images to save space
            echo "ğŸ§¹ Cleaning up old Docker images..."
            sudo docker image prune -f
          else
            echo "âŒ Health check failed after deployment!"
            echo "ğŸ”„ Attempting rollback..."
            sudo docker-compose -f docker-compose.prod.yml restart backend
            exit 1
          fi

    - name: "ğŸŒ Verify Public Access"
      run: |
        echo "ğŸ” Verifying public application access..."
        EC2_IP="${{ needs.check-infrastructure.outputs.ec2_host }}"
        if curl -f -s "https://brb.elvisquant.com/health" > /dev/null 2>&1; then
          echo "âœ… Application is publicly accessible at https://brb.elvisquant.com"
        elif curl -f -s "http://$EC2_IP/health" > /dev/null 2>&1; then
          echo "âš ï¸  Application running at http://$EC2_IP (DNS might still be propagating)"
        else
          echo "âŒ Application not accessible yet"
        fi

  infrastructure-not-ready:
    runs-on: ubuntu-latest
    needs: check-infrastructure
    if: needs.check-infrastructure.outputs.infrastructure_ready == 'false'
    
    steps:
    - name: "âŒ Infrastructure Not Ready"
      run: |
        echo "âŒ Cannot deploy application - infrastructure is not ready"
        echo ""
        echo "ğŸ“‹ Required conditions:"
        echo "   - Infrastructure pipeline must complete successfully"
        echo "   - EC2_IP secret must be set"
        echo ""
        echo "ğŸ’¡ Next steps:"
        echo "1. Check the Infrastructure Deployment workflow"
        echo "2. Make sure it completed successfully"
        echo "3. Trigger infrastructure deployment if needed"
        echo ""
        echo "ğŸ”— Infrastructure workflow: https://github.com/${{ github.repository }}/actions/workflows/2-infrastructure.yml"