name: "3. ğŸš€ Application Deployment"

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'infrastructure/**'
      - '.github/workflows/1-initial-setup.yml'
      - '.github/workflows/2-infrastructure.yml'
  workflow_dispatch:

env:
  DOCKER_REGISTRY: docker.io

jobs:
  deploy-application:
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4

    - name: "ğŸ³ Set up Docker Buildx"
      uses: docker/setup-buildx-action@v3

    - name: "ğŸ” Login to Docker Hub"
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: "ğŸ·ï¸ Extract version information"
      id: version
      run: |
        echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "âœ… Version: $(git rev-parse --short HEAD)"

    - name: "ğŸ—ï¸ Build and push Docker image"
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/brb-app-backend:${{ steps.version.outputs.IMAGE_TAG }}
          ${{ secrets.DOCKER_USERNAME }}/brb-app-backend:latest
        build-args: |
          COMMIT_SHA=${{ github.sha }}

    - name: "ğŸš€ Deploy to EC2 Instance"
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_IP }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        script: |
          set -e
          echo "ğŸ¯ Starting application deployment..."
          
          # Wait for Docker to be ready
          until docker info > /dev/null 2>&1; do
            echo "â³ Waiting for Docker to be ready..."
            sleep 10
          done
          
          cd /opt/brb-app
          
          # Update environment with new version
          echo "ğŸ”„ Updating environment with new version..."
          sudo sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=${{ steps.version.outputs.IMAGE_TAG }}/" .env
          sudo sed -i "s/COMMIT_SHA=.*/COMMIT_SHA=${{ github.sha }}/" .env
          
          # Ensure we have the latest docker-compose file
          echo "ğŸ“¥ Ensuring latest docker-compose file..."
          if [ ! -f docker-compose.prod.yml ]; then
            echo "ğŸ“‹ Downloading docker-compose file..."
            curl -o docker-compose.prod.yml \
              "https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.prod.yml"
          fi
          
          # Pull and deploy new version
          echo "ğŸ³ Pulling new Docker image..."
          sudo docker-compose -f docker-compose.prod.yml pull backend
          
          echo "ğŸ”„ Starting services..."
          sudo docker-compose -f docker-compose.prod.yml up -d
          
          # Wait for health check with retries
          echo "â³ Waiting for application to be healthy..."
          for i in {1..12}; do
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Application health check passed!"
              break
            fi
            echo "Attempt $i/12: Application not ready yet..."
            sleep 10
          done
          
          # Final verification
          if curl -f http://localhost:8000/health; then
            echo "ğŸ‰ Deployment successful!"
            echo "ğŸ“¦ New version: ${{ steps.version.outputs.IMAGE_TAG }}"
            echo "ğŸŒ Application URL: https://brb.elvisquant.com"
            
            # Cleanup old images to save space
            echo "ğŸ§¹ Cleaning up old Docker images..."
            sudo docker image prune -f
          else
            echo "âŒ Health check failed after deployment!"
            echo "ğŸ”„ Attempting rollback..."
            sudo docker-compose -f docker-compose.prod.yml restart backend
            exit 1
          fi

    - name: "ğŸŒ Verify Public Access"
      run: |
        echo "ğŸ” Verifying public application access..."
        if curl -f -s "https://brb.elvisquant.com/health" > /dev/null 2>&1; then
          echo "âœ… Application is publicly accessible at https://brb.elvisquant.com"
        else
          echo "âš ï¸  Application might not be publicly accessible yet (check DNS propagation)"
        fi

    - name: "ğŸ“‹ Deployment Complete"
      run: |
        echo "ğŸ‰ APPLICATION DEPLOYMENT COMPLETE!"
        echo "==================================="
        echo "âœ… New version deployed successfully"
        echo "âœ… Docker image built and pushed"
        echo "âœ… Services running on EC2 instance"
        echo "âœ… Health checks passing"
        echo ""
        echo "ğŸŒ Your application is live at: https://brb.elvisquant.com"